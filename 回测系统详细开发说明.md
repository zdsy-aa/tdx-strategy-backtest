# 股票指标回测系统 (Stock Strategy Backtest System) - 深度开发说明文档

**版本**: 3.0.0
**更新日期**: 2026-01-11
**作者**: Manus AI

---

## 1. 项目愿景与核心价值

本系统是一个专为 A 股市场设计的**全栈量化回测平台**。它不仅提供了从数据抓取到可视化展示的完整链路，更核心的价值在于其**“通达信兼容”**的指标计算引擎，使得投资者能够将传统的盘感经验转化为可量化的数据验证。

---

## 2. 系统全景架构

系统采用“离线计算 + 静态展示”的架构模式，极大地降低了服务器成本并提升了访问速度。

### 2.1 目录结构深度解析

```text
tdx-strategy-backtest/
├── data/                   # 数据中心
│   └── day/                # 原始日线 CSV 数据，按市场(sh/sz/bj)分类
├── py_file/                # 后端核心 (Python)
│   ├── indicators.py       # 指标计算引擎 (核心中的核心)
│   ├── stock_downloader.py # 多功能数据下载器
│   ├── full_backtest.py    # 全量回测主引擎
│   ├── 10x_..._test.py     # 单指标专项测试脚本
│   └── 20x_..._test.py     # 组合指标专项测试脚本
├── web/                    # 前端展示 (React + Vite)
│   ├── client/src/data/    # 核心数据接口 (JSON 文件)
│   ├── client/src/pages/   # 页面组件 (Dashboard, Backtest, Reports等)
│   └── client/src/components/# 通用 UI 组件 (基于 shadcn/ui)
├── config/                 # 系统配置
│   └── skip_stocks.json    # 自动维护的停牌/退市跳过列表
└── 回测系统详细开发说明.md    # 本文档
```

---

## 3. 后端核心模块详解

### 3.1 数据下载引擎 (`stock_downloader.py`)

该模块负责维持系统的数据生命线。

*   **多模式支持**:
    *   `--full`: 暴力全量下载，适合首次部署。
    *   `--incremental`: 智能增量更新，读取本地 CSV 最后一行日期，仅抓取缺失部分并进行 `drop_duplicates` 合并。
    *   `--stocks`: 针对性下载，方便快速调试特定个股。
*   **智能过滤机制**:
    *   **10日无交易检测**: 自动识别长期停牌或已退市股票。
    *   **跳过列表**: 将无效股票记录在 `config/skip_stocks.json` 中，避免在后续的 5000+ 股票循环中浪费 API 请求。

### 3.2 指标计算引擎 (`indicators.py`)

这是系统的数学灵魂，完美复刻了通达信（TDX）的计算逻辑。

*   **基础函数库**: 实现了 `EMA`, `SMA`, `LLV`, `HHV`, `CROSS` 等通达信核心函数。
*   **高级策略实现**:
    *   **六脉神剑**: 融合了 MACD, KDJ, RSI, LW&R, BBI, ZLMM 六大维度的共振判断。
    *   **缠论买点**: 基于分型、笔、线段逻辑，识别一买（趋势背驰）、二买（回抽不破底）、三买（中枢突破回踩）。
    *   **买卖点策略**: 基于均线多头排列与量价背离的综合判断。

### 3.3 回测主引擎 (`full_backtest.py`)

负责将数据与策略结合，产出统计结果。

*   **回测逻辑**: 默认采用“买入后持有 N 天”的固定周期回测模式，旨在验证信号的**统计有效性**而非复杂的择时卖出。
*   **多维度统计**:
    *   **总计**: 历史全样本胜率、平均收益。
    *   **年度/月度**: 揭示策略在不同市场环境（牛/熊/震荡）下的表现差异。
*   **性能优化**: 针对 5000+ 股票的计算，采用了 Pandas 向量化操作，避免了低效的 Python 循环。

---

## 4. 前端可视化系统详解

### 4.1 技术栈
*   **React 19 + Vite**: 极致的开发体验与运行效率。
*   **Tailwind CSS 4**: 响应式布局与暗黑模式支持。
*   **Recharts**: 专业的量化图表展示。

### 4.2 核心页面逻辑
*   **仪表盘 (Dashboard)**: 汇总 `backtest_results.json`，展示全市场表现最好的策略。
*   **回测验证 (Backtest)**: 动态渲染年度/月度胜率热力图，直观发现策略的“失效期”。
*   **报告明细 (Report Detail)**: 
    *   **大数据量处理**: 实现了前端分页与模糊搜索。
    *   **视觉反馈**: 遵循中国股市习惯（红涨绿跌），对收益率进行颜色编码。

---

## 5. 数据流转机制 (Data Pipeline)

1.  **采集**: `stock_downloader.py` -> `data/day/*.csv`
2.  **计算**: `full_backtest.py` 调用 `indicators.py` 处理 CSV。
3.  **产出**: `full_backtest.py` -> `web/client/src/data/*.json`
4.  **消费**: React 组件通过 `import data from './data/backtest_results.json'` 直接加载。

---

## 6. 开发者指南：如何添加新策略？

1.  **定义指标**: 在 `py_file/indicators.py` 中编写计算逻辑，确保返回一个包含信号列（True/False）的 DataFrame。
2.  **注册策略**: 在 `py_file/full_backtest.py` 的 `signal_types` 列表中添加你的策略 ID。
3.  **运行回测**: 执行 `python py_file/full_backtest.py`。
4.  **前端展示**: 刷新网页，新策略将自动出现在排行榜和明细表中。

---

## 7. 常见问题与坑点 (FAQ)

*   **编码问题**: A 股数据 CSV 常带 BOM 头，读取时务必使用 `encoding='utf-8-sig'`。
*   **数据清洗**: 上市不足 100 天的股票建议跳过，否则会因样本量过小导致胜率数据失真。
*   **内存管理**: 虽然 Pandas 很快，但在处理 5000+ 股票时，建议在每只股票处理完后显式释放 DataFrame。

---

**Manus AI 团队 倾力打造**
