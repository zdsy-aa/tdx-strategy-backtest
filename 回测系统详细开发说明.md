# 股票指标回测系统详细开发说明

> **版本**: 5.4.0
> **更新日期**: 2026-01-12
> **作者**: Manus AI

---

## 1. 项目愿景与架构

### 1.1 核心目标

本系统旨在为量化交易爱好者和开发者提供一个**高度可复刻、可扩展的A股技术指标回测平台**。其核心价值在于将经典的“通达信”指标逻辑通过代码实现，并提供一套完整的数据处理、回测、可视化流程，让策略验证和二次开发变得简单高效。

### 1.2 系统架构

系统采用**“离线计算 + 静态展示”**的架构，这是一种兼具高性能和低成本的解决方案。

*   **离线计算 (Python Backend)**: 后端通过 Python 脚本负责所有重计算任务，包括从 `akshare` 下载数据、清洗、计算上百种技术指标、执行策略回测，并最终将结果序列化为 JSON 文件。
*   **静态展示 (React Frontend)**: 前端是一个纯粹的静态网站（由 Vite 构建），它不依赖动态服务器，而是直接读取后端生成的 JSON 文件来渲染图表和表格。

---

## 2. 数据流转与调度逻辑 (高精度版)

本图表详细描述了从原始行情获取到前端页面展示的完整调度顺序，并标注了关键 JSON 数据与网页功能的对应关系。

```mermaid
graph TD
    %% 第一阶段：数据准备
    subgraph Phase1_Data_Preparation
        API[akshare接口] -- 原始行情 --> DL[stock_downloader.py]
        DL -- 存储 --> CSV[data/day/*.csv]
        DL -- 记录 --> SKIP[skipped_stocks.json]
    end

    %% 第二阶段：指标计算 (逻辑支撑类)
    subgraph Phase2_Logic_Support
        CSV -- 读取 --> DF[Pandas_DataFrame]
        IND[indicators.py] -- 提供算法 --> DF
        FET[data_fetcher.py] -- 提供读取 --> DF
    end

    %% 第三阶段：策略回测 (核心输出)
    subgraph Phase3_Backtesting
        DF -- 综合回测 --> FB[full_backtest.py]
        DF -- 详细报告 --> GSR[generate_stock_reports.py]
        
        FB -- 生成汇总 --> BT_JSON[backtest_results.json]
        GSR -- 生成详情 --> SR_JSON[stock_reports.json]
    end

    %% 第四阶段：独立分析 (MD报告输出)
    subgraph Phase4_Independent_Analysis
        DF -- 专项测试 --> T10X[101-105_Test_Scripts]
        DF -- 组合测试 --> T20X[201-202_Combo_Scripts]
        
        T10X -- 生成报告 --> MD_REP[report/total/*.md]
        T20X -- 生成报告 --> CSV_REP[report/total/*.csv]
    end

    %% 第五阶段：网页同步
    subgraph Phase5_Web_Sync
        BT_JSON -- 汇总数据 --> UWD[update_web_data.py]
        UWD -- 网页配置 --> STR_JSON[strategies.json]
    end

    %% 第六阶段：前端展示 (JSON对应关系)
    subgraph Phase6_Frontend_Display
        BT_JSON -- 驱动 --> PAGE1[回测报告页 Backtest.tsx]
        SR_JSON -- 驱动 --> PAGE2[报告详情页 ReportDetail.tsx]
        STR_JSON -- 驱动 --> PAGE3[策略列表页 Strategies.tsx]
        SKIP -- 驱动 --> PAGE4[系统状态说明]
    end

    %% 样式美化
    style API fill:#f9f,stroke:#333,stroke-width:2px
    style CSV fill:#bbf,stroke:#333,stroke-width:2px
    style BT_JSON fill:#ff9,stroke:#333,stroke-width:2px
    style SR_JSON fill:#ff9,stroke:#333,stroke-width:2px
    style STR_JSON fill:#ff9,stroke:#333,stroke-width:2px
    style PAGE1 fill:#bfb,stroke:#333,stroke-width:2px
    style PAGE2 fill:#bfb,stroke:#333,stroke-width:2px
    style PAGE3 fill:#bfb,stroke:#333,stroke-width:2px
```

---

## 3. JSON 数据与网页功能映射表

| JSON 文件名 | 对应网页页面/功能 | 数据来源脚本 | 详细说明 |
| :--- | :--- | :--- | :--- |
| `backtest_results.json` | **回测报告页 (Backtest.tsx)** | `full_backtest.py` | 包含所有策略的综合回测统计数据（胜率、收益率、最大回撤等）。 |
| `stock_reports.json` | **报告详情页 (ReportDetail.tsx)** | `generate_stock_reports.py` | 包含单只股票的详细回测表现、信号触发记录及 K 线标注数据。 |
| `strategies.json` | **策略列表页 (Strategies.tsx)** | `update_web_data.py` | 包含策略的元数据说明、参数配置、展示分类及首页推荐逻辑。 |
| `skipped_stocks.json` | **系统状态说明** | `stock_downloader.py` | 记录因长期停牌、退市或数据异常被系统自动跳过的股票列表。 |

---

## 4. 核心模块深度解析

### 4.1 数据获取与预处理

系统的数据流从 `akshare` 开始。`stock_downloader.py` 是整个系统的“水源”，它负责将网络上的原始行情数据转化为本地的 CSV 文件。

*   **增量更新机制**: 脚本会检查本地已有的数据日期，仅下载缺失的部分并进行合并。
*   **自动跳过逻辑**: 对于长期停牌或退市的股票，系统会自动将其加入 `skipped_stocks.json`。

### 4.2 策略回测引擎

`full_backtest.py` 是系统的核心大脑。它通过多进程并行计算，遍历数千只股票的历史数据。

*   **指标计算**: 依赖 `indicators.py`，将通达信公式转化为高性能的 Pandas 向量化运算。
*   **信号触发**: 策略逻辑会扫描 DataFrame，识别出买入和卖出信号。

### 4.3 前端展示系统

前端采用 React + TailwindCSS 构建，通过 `Vite` 进行极速打包。

*   **零后端依赖**: 前端直接通过 `import` 导入 JSON 数据，无需运行任何 API 服务器。
*   **交互式图表**: 使用 `Recharts` 渲染收益曲线和分布图。

---

## 5. 如何复刻与二次开发

### 5.1 复刻流程

1.  **环境准备**: 安装 Python 3.11+ 和 Node.js 18+。
2.  **安装依赖**: `pip install -r requirements.txt` 和 `pnpm install`。
3.  **下载数据**: `python py_file/stock_downloader.py --full`。
4.  **运行回测**: `python py_file/full_backtest.py`。
5.  **同步网页**: `python py_file/update_web_data.py`。
6.  **启动 Web**: `cd web && pnpm dev`。
