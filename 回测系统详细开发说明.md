# 回测系统详细开发说明文档

> **版本**: 5.1.0
> **更新日期**: 2026-01-12
> **作者**: Manus AI

---

## 1. 项目愿景与架构

### 1.1 核心目标

本系统旨在为量化交易爱好者和开发者提供一个**高度可复刻、可扩展的A股技术指标回测平台**。其核心价值在于将经典的“通达信”指标逻辑通过代码实现，并提供一套完整的数据处理、回测、可视化流程，让策略验证和二次开发变得简单高效。

### 1.2 系统架构

系统采用**“离线计算 + 静态展示”**的架构，这是一种兼具高性能和低成本的解决方案。

*   **离线计算 (Python Backend)**: 后端通过 Python 脚本负责所有重计算任务，包括从 `akshare` 下载数据、清洗、计算上百种技术指标、执行策略回测，并最终将结果序列化为 JSON 文件。
*   **静态展示 (React Frontend)**: 前端是一个纯粹的静态网站（由 Vite 构建），它不依赖动态服务器，而是直接读取后端生成的 JSON 文件来渲染图表和表格。这种模式使得前端可以轻松部署在任何静态托管服务上（如 Vercel, Netlify, 或 Nginx）。

**数据流转图:**

```mermaid
graph TD
    subgraph 数据源
        A[akshare API] -- 获取原始数据 --> B(stock_downloader.py)
    end

    subgraph Python 后端
        B -- 生成/更新 --> C[data/day/*.csv]
        C -- 股票数据 --> D(indicators.py)
        D -- 计算指标 --> E[DataFrame (含指标)]

        E -- 全市场回测 --> F(full_backtest.py)
        E -- 个股报告生成 --> G(generate_stock_reports.py)
        E -- 缠论买点测试 --> H(105_chan_5buy_test.py)

        F -- 生成 --> I[web/client/src/data/backtest_results.json]
        G -- 生成 --> J[web/client/src/data/stock_reports.json]
        H -- 生成 --> K[web/client/src/data/chan_backtest_results.json]

        L(update_web_data.py) -- 同步数据 --> I
        L -- 同步数据 --> J
        L -- 同步数据 --> K
        L -- 同步数据 --> M[web/client/src/data/strategies.json]
    end

    subgraph 前端应用
        I -- 策略总览数据 --> N{页面: Reports.tsx}
        J -- 个股报告数据 --> O{页面: ReportDetail.tsx}
        K -- 缠论买点数据 --> P{页面: Indicators.tsx}
        M -- 策略定义数据 --> P
        M -- 策略定义数据 --> Q{页面: Strategies.tsx}
    end

    N & O & P & Q -- 渲染 --> R[用户界面]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#ccf,stroke:#333,stroke-width:2px
    style I fill:#ccf,stroke:#333,stroke-width:2px
    style J fill:#ccf,stroke:#333,stroke-width:2px
    style K fill:#ccf,stroke:#333,stroke-width:2px
    style M fill:#ccf,stroke:#333,stroke-width:2px
    style R fill:#afa,stroke:#333,stroke-width:2px
```

---

## 2. 核心模块深度解析

### 2.1 目录结构

一个清晰的目录结构是项目可维护性的基石。

```text
tdx-strategy-backtest/
├── data/                      # 数据中心
│   └── day/                   # 股票日线数据 (按 sh, sz, bj 市场分子目录存放)
├── py_file/                   # Python 后端核心
│   ├── 101_six_veins_test.py  # 六脉神剑策略独立测试脚本
│   ├── 102_buy_sell_points_test.py # 基础买卖点策略独立测试脚本
│   ├── 103_chan_buy_point_test.py # 缠论买点策略独立测试脚本 (旧版)
│   ├── 104_test_sell_points.py # 基础卖点策略独立测试脚本
│   ├── 105_chan_5buy_test.py  # 缠论5买点独立测试脚本 (新版)
│   ├── 201_steady_combo_test.py # 稳健组合策略独立测试脚本
│   ├── 202_aggressive_combo_test.py # 激进组合策略独立测试脚本
│   ├── auto_update_daily.py   # 每日自动化更新脚本 (用于定时任务)
│   ├── bottom_fishing_strategy.py # 抄底策略脚本
│   ├── data_fetcher.py        # 数据获取辅助脚本
│   ├── fetch_stock_names.py   # 股票名称获取脚本
│   ├── fix_backtest_json.py   # 修复回测JSON的辅助脚本
│   ├── fix_stock_names.py     # 修复股票名称的辅助脚本
│   ├── force_update_data.py   # 强制更新数据脚本
│   ├── full_backtest.py       # 策略统计回测引擎 (已并行化)
│   ├── generate_stock_reports.py # 个股报告生成器 (已并行化)
│   ├── generate_web_data.py   # 生成前端数据的辅助脚本
│   ├── get_all_stocks.py      # 获取所有股票列表的辅助脚本
│   ├── indicators.py          # 指标计算引擎 (项目的“数学灵魂”)
│   ├── indicators_chan.py     # 缠论指标计算脚本 (旧版，已废弃)
│   ├── quick_backtest.py      # 快速回测脚本
│   ├── scheduled_data_update.py # 定时数据更新脚本
│   ├── simple_backtest.py     # 简单回测脚本
│   ├── stock_downloader.py    # 多功能数据下载器
│   ├── update_stock_names_in_csv.py # 更新CSV中股票名称的辅助脚本
│   └── update_web_data.py     # 数据同步脚本
├── web/                       # 前端应用 (Vite + React)
│   ├── client/src/            # 前端源码
│   │   ├── pages/             # 核心页面组件 (如 ReportDetail.tsx)
│   │   ├── components/        # 可复用UI组件
│   │   └── data/              # 关键数据接口 (由Python生成的JSON文件)
│   └── package.json           # 前端依赖与脚本配置
├── deploy/                    # 自动化部署脚本和配置
├── venv/                      # Python 虚拟环境 (本地生成)
├── requirements.txt           # Python 依赖清单
├── 项目部署手册.md            # 部署指南
└── 回测系统详细开发说明.md    # 本文档
```

### 2.2 后端引擎 (`py_file/`)
`py_file/` 目录包含了所有处理数据、计算指标和执行回测的 Python 脚本。它们是整个系统的“大脑”，负责生成前端所需的所有数据。

#### `stock_downloader.py` - 数据生命线
*   **功能**: 此脚本是整个系统的数据源头，负责从 `akshare` 获取并维护本地的股票数据副本。
*   **核心逻辑**: 
    *   支持 `--full` (全量) 和 `--incremental` (增量) 两种模式，能够智能地创建和更新本地超过5000个股票的CSV文件。
    *   通过 `ak.stock_zh_a_spot_em()` 获取所有A股代码列表。
    *   自动检测并记录长期不交易的股票到 `config/skip_stocks.json`，避免在每日更新中浪费API请求和时间。
    *   下载的数据按市场（`sh`, `sz`, `bj`）分子目录存放于 `data/day/` 目录下，每个股票一个CSV文件，例如 `data/day/sh/600000.csv`。
*   **数据输出**: `data/day/*.csv` (包含股票代码、名称、日期、开盘、收盘、最高、最低、成交量等)。
*   **对前端的影响**: `stock_downloader.py` 间接影响前端，因为它提供了所有回测和报告生成所需的基础数据。如果数据未下载或不完整，后续的回测和报告将无法生成，导致前端页面无数据或数据陈旧。

#### `indicators.py` - 指标计算核心

*   **功能**: 这是整个项目技术含量的核心，它将通达信的公式语言（如 `MA`, `REF`, `CROSS`）用纯 Python 和 Pandas 进行了复现，为策略回测提供基础。
*   **核心逻辑**: 
    *   实现了 `EMA`, `SMA`, `HHV`, `LLV`, `REF`, `CROSS` 等通达信基础函数，是构建任何复杂指标的基石。
    *   在基础函数之上，封装了如 `calculate_six_veins` (六脉神剑), `calculate_buy_sell_points` (基础买卖点) 等高级策略。
    *   **新增缠论5买3卖**: `calculate_chan_theory` 函数已重构，严格按照通达信公式实现了5个买点（一买、二买、三买、强二买、类二买）和3个卖点（一卖、二卖、三卖）的计算。
*   **数据输出**: 不直接输出文件，而是为其他脚本（如 `full_backtest.py` 和 `generate_stock_reports.py`）提供带有计算指标的 DataFrame。
*   **对前端的影响**: `indicators.py` 定义了所有策略的计算逻辑。前端展示的所有策略结果（如胜率、收益率、信号类型）都来源于此脚本定义的指标。任何策略的修改或新增都将在此脚本中进行，并最终体现在前端的报告中。

#### `full_backtest.py` - 策略统计回测引擎 (已并行化)

*   **功能**: 遍历所有股票数据，针对**多种策略**进行回测，计算其在总、年、月维度下的胜率和收益，生成策略排行榜数据。
*   **核心逻辑**: 
    *   **并行处理**: 利用 `multiprocessing.Pool` 模块，将每只股票的回测任务分配到多个 CPU 核心并行执行，显著提升了处理大量股票时的回测速度。
    *   **新增缠论5买点支持**: `strategies` 列表已更新，包含 `chan_buy1`, `chan_buy2`, `chan_buy3`, `chan_strong_buy2`, `chan_like_buy2`。
    *   `find_signals` 函数已更新，支持识别新的缠论买点信号。
*   **数据输出**: `web/client/src/data/backtest_results.json`。此 JSON 文件包含一个列表，每个元素代表一个策略的汇总回测统计数据。
*   **对前端的影响**: `backtest_results.json` 是前端 **“策略总览”** 页面 (`web/client/src/pages/Reports.tsx` 或类似页面) 的数据源。该页面会展示所有策略的排行榜，用户可以根据不同的统计指标（如总收益、胜率）进行排序和筛选，从而快速评估不同策略的表现。

#### `generate_stock_reports.py` - 个股报告生成器 (已并行化)

*   **功能**: 遍历所有股票，为**每一只股票**生成一个总的回测报告（综合所有策略的表现），并产出详细的股票明细数据。
*   **核心逻辑**: 
    *   **并行处理**: 同样利用 `multiprocessing.Pool` 模块，将每只股票的报告生成任务分配到多个 CPU 核心并行执行，加快了报告生成速度。
    *   **新增缠论5买点统计**: 脚本现在会统计缠论5个买点的交易，并将其包含在 `all_trades` 中。
*   **数据输出**: `web/client/src/data/stock_reports.json`。此 JSON 文件包含一个列表，每个元素代表一只股票的详细回测报告。
*   **对前端的影响**: `stock_reports.json` 是前端 **“报告明细”** 页面 (`web/client/src/pages/ReportDetail.tsx`) 的数据源。该页面会以表格形式展示所有股票的详细回测数据，用户可以搜索特定股票、按市场筛选、按各项指标排序，并导出CSV，提供了类似Excel的交互体验。

#### `105_chan_5buy_test.py` - 缠论5买点独立测试脚本

*   **功能**: 这是一个新增的独立测试脚本，专门用于对缠论5个买点进行独立回测，分析每个买点的胜率和收益表现。
*   **核心逻辑**: 
    *   并行处理所有股票，对每个买点（一买、二买、三买、强二买、类二买）进行独立的回测。
    *   统计每个买点的交易次数、胜率、平均收益等指标。
*   **数据输出**: `web/client/src/data/chan_backtest_results.json`。此 JSON 文件包含每个缠论买点的详细回测统计数据。
*   **对前端的影响**: `chan_backtest_results.json` 是前端 **“指标详解”** 页面 (`web/client/src/pages/Indicators.tsx`) 中缠论部分的**数据源**，用于展示每个买点的历史表现。

#### `update_web_data.py` - 数据同步脚本

*   **功能**: 负责将后端生成的 JSON 数据文件同步到前端 `web/client/src/data/` 目录，确保前端展示的数据是最新的。
*   **核心逻辑**: 
    *   读取 `py_file` 目录下生成的 `backtest_results.json`, `stock_reports.json`, `chan_backtest_results.json` 等文件。
    *   将这些文件复制或移动到前端指定的 `web/client/src/data/` 目录。
    *   同时，该脚本也负责更新 `web/client/src/data/strategies.json`，确保前端的策略定义与后端保持一致。
*   **数据输出**: 更新前端 `web/client/src/data/` 目录下的 JSON 文件。
*   **对前端的影响**: 确保前端所有页面都能获取到最新的回测数据和策略定义。

#### `auto_update_daily.py` - 每日自动化更新脚本

*   **功能**: 这是一个用于自动化每日数据更新和回测的脚本，通常配合操作系统的定时任务（如 Linux 的 `cron` 或 Windows 的任务计划程序）使用。
*   **核心逻辑**: 
    *   依次调用 `stock_downloader.py` (增量更新模式)、`full_backtest.py`、`generate_stock_reports.py`、`105_chan_5buy_test.py` 和 `update_web_data.py`。
    *   实现一键式的每日数据更新和报告生成。
*   **数据输出**: 间接通过调用其他脚本生成所有回测数据和报告。
*   **对前端的影响**: 确保前端每天都能展示最新的股票数据和回测结果。

#### `bottom_fishing_strategy.py` - 抄底策略脚本

*   **功能**: 实现一个特定的抄底策略，用于识别潜在的买入机会。
*   **核心逻辑**: 
    *   根据预设的指标（如超跌、背离等）计算抄底信号。
    *   通常会与 `full_backtest.py` 结合使用，作为其中一个策略进行回测。
*   **数据输出**: 不直接输出文件，而是提供抄底信号给回测引擎。
*   **对前端的影响**: 如果该策略被 `full_backtest.py` 包含，其回测结果将显示在前端的策略总览页面。

#### `data_fetcher.py` - 数据获取辅助脚本

*   **功能**: 提供一些通用的数据获取函数，供其他脚本调用。
*   **核心逻辑**: 
    *   封装 `akshare` 的一些常用接口，简化数据获取过程。
    *   可能包含数据缓存、重试机制等。
*   **数据输出**: 提供 DataFrame 格式的股票数据。
*   **对前端的影响**: 无直接影响，作为后端内部工具。

#### `fetch_stock_names.py` - 股票名称获取脚本

*   **功能**: 专门用于获取股票代码和名称的映射关系。
*   **核心逻辑**: 
    *   从 `akshare` 获取最新的 A 股列表。
    *   将代码和名称保存为文件或提供给其他脚本。
*   **数据输出**: 股票代码和名称列表。
*   **对前端的影响**: 无直接影响，作为后端内部工具。

#### `fix_backtest_json.py` - 修复回测JSON的辅助脚本

*   **功能**: 用于修复 `backtest_results.json` 文件中可能存在的格式或数据问题。
*   **核心逻辑**: 
    *   读取损坏的 JSON 文件，尝试进行解析和修正。
    *   通常用于在开发过程中出现意外错误时的数据恢复。
*   **数据输出**: 修复后的 `backtest_results.json`。
*   **对前端的影响**: 确保前端能够正常加载回测总览数据。

#### `fix_stock_names.py` - 修复股票名称的辅助脚本

*   **功能**: 用于修正 `stock_reports.json` 中股票名称显示不正确的问题（例如将“沪市600000”修正为“浦发银行”）。
*   **核心逻辑**: 
    *   读取 `stock_reports.json` 和包含正确股票名称的 CSV 文件。
    *   根据股票代码进行匹配，更新 `stock_reports.json` 中的股票名称字段。
*   **数据输出**: 修正后的 `stock_reports.json`。
*   **对前端的影响**: 确保前端的个股报告页面显示正确的股票名称。

#### `force_update_data.py` - 强制更新数据脚本

*   **功能**: 强制下载所有股票的最新数据，不考虑增量更新或跳过列表。
*   **核心逻辑**: 
    *   调用 `stock_downloader.py` 的全量更新逻辑，但会忽略任何跳过列表或增量更新的判断。
    *   通常用于数据初始化或数据异常需要完全重新下载时。
*   **数据输出**: `data/day/*.csv`。
*   **对前端的影响**: 间接影响，提供最新的原始数据。

#### `generate_web_data.py` - 生成前端数据的辅助脚本

*   **功能**: 这是一个通用脚本，用于生成或处理前端所需的各种数据文件。
*   **核心逻辑**: 
    *   可能包含将后端计算结果转换为前端特定格式的逻辑。
    *   与 `update_web_data.py` 功能类似，但可能更侧重于数据的生成而非简单的同步。
*   **数据输出**: `web/client/src/data/` 目录下的 JSON 文件。
*   **对前端的影响**: 为前端提供数据。

#### `get_all_stocks.py` - 获取所有股票列表的辅助脚本

*   **功能**: 简单地获取并返回所有 A 股的列表。
*   **核心逻辑**: 
    *   调用 `akshare` 接口获取股票列表。
    *   通常作为其他脚本的子模块或辅助工具。
*   **数据输出**: 股票代码和名称列表。
*   **对前端的影响**: 无直接影响。

#### `indicators_chan.py` - 缠论指标计算脚本 (旧版，已废弃)

*   **功能**: 缠论指标的旧版本实现，已被 `indicators.py` 中的 `calculate_chan_theory` 函数取代。
*   **核心逻辑**: 包含旧的缠论买卖点计算逻辑。
*   **数据输出**: 无。
*   **对前端的影响**: 无。

#### `quick_backtest.py` - 快速回测脚本

*   **功能**: 提供一个快速、简化的回测入口，通常用于单个策略或少量股票的快速验证。
*   **核心逻辑**: 
    *   可能跳过部分复杂的统计或报告生成步骤。
    *   方便开发者快速测试新策略的初步效果。
*   **数据输出**: 简化的回测结果，可能直接打印到控制台或生成临时文件。
*   **对前端的影响**: 无直接影响，主要用于开发调试。

#### `scheduled_data_update.py` - 定时数据更新脚本

*   **功能**: 类似于 `auto_update_daily.py`，用于定时执行数据更新任务。
*   **核心逻辑**: 
    *   可能包含更复杂的调度逻辑或错误处理机制。
    *   确保数据在特定时间自动更新。
*   **数据输出**: 间接通过调用其他脚本生成所有回测数据和报告。
*   **对前端的影响**: 确保前端展示的数据是最新的。

#### `simple_backtest.py` - 简单回测脚本

*   **功能**: 提供一个最基础的回测框架，通常用于教学或概念验证。
*   **核心逻辑**: 
    *   只包含最核心的回测逻辑，不涉及复杂的指标计算或统计。
    *   方便理解回测的基本原理。
*   **数据输出**: 简化的回测结果。
*   **对前端的影响**: 无直接影响。

#### `update_stock_names_in_csv.py` - 更新CSV中股票名称的辅助脚本

*   **功能**: 用于更新 `data/day/*.csv` 文件中的股票名称字段。
*   **核心逻辑**: 
    *   读取最新的股票名称映射。
    *   遍历所有 CSV 文件，更新其中的股票名称。
*   **数据输出**: 更新后的 `data/day/*.csv`。
*   **对前端的影响**: 间接影响，确保原始数据中的股票名称正确。

### 2.3 前端系统 (`web/`)

前端采用现代化的技术栈，提供了流畅的用户体验。它通过直接读取后端生成的 JSON 文件来渲染数据。

*   **技术栈**: Vite + React 19 + TypeScript + TailwindCSS + shadcn/ui + Recharts。
*   **数据消费**: 前端组件通过简单的 `import` 语句直接加载 `web/client/src/data/` 下的 JSON 文件。例如，在 `ReportDetail.tsx` 中：
    ```typescript
    import stockReportsData from "@/data/stock_reports.json";
    ```
    这种方式极大地简化了数据传递，避免了复杂的API请求和状态管理。
*   **核心页面 (`web/client/src/pages/`)**: 
    *   **`Indicators.tsx`**: 主要展示指标详解。它消费 `web/client/src/data/strategies.json` 来展示指标的定义、信号、公式等，并消费 `chan_backtest_results.json` 来展示缠论各买点的回测数据。
    *   **`Strategies.tsx`**: 主要展示策略方案。它消费 `web/client/src/data/strategies.json` 来展示单指标买入方案和组合方案。
    *   **`Reports.tsx`**: 主要展示策略总览和排行榜。它消费 `web/client/src/data/backtest_results.json`，将不同策略的汇总表现（如总收益、胜率）以图表和表格形式呈现。
    *   **`ReportDetail.tsx`**: 负责展示个股的详细回测报告。它消费 `web/client/src/data/stock_reports.json`，提供股票代码/名称搜索、市场筛选、多列排序和CSV导出功能，是用户深入分析个股表现的核心界面。
*   **可复用组件 (`web/client/src/components/`)**: 
    *   **`IndicatorCard.tsx`**: 负责展示单个指标的详细信息。已更新，支持展示 `formula`, `risk`, `meaning` 等新字段。

---

## 3. 如何复刻与二次开发

### 3.1 复刻流程

1.  **环境准备**: 确保你的机器上已安装 Python 3.11+ 和 Node.js 18+。
2.  **克隆与安装**: 按照 `项目部署手册.md` 的指引，完成项目克隆、Python依赖安装 (`pip install -r requirements.txt`) 和前端依赖安装 (`pnpm install`)。
3.  **数据下载**: 激活虚拟环境，进入 `py_file` 目录，执行 `python stock_downloader.py --full`。等待其完成。
4.  **生成报告 (并行化)**: 继续在 `py_file` 目录下，依次执行 `python full_backtest.py`, `python generate_stock_reports.py`, `python 105_chan_5buy_test.py`。
5.  **启动前端**: 进入 `web` 目录，运行 `pnpm dev`。
6.  **访问**: 打开浏览器，访问 `http://localhost:5173`。

### 3.2 如何添加一个新策略？

1.  **定义指标**: 在 `py_file/indicators.py` 中，仿照现有函数（如 `calculate_six_veins`），编写你的新策略计算逻辑。
2.  **注册策略**: 打开 `py_file/full_backtest.py`，在 `strategies` 列表中加入你的新策略ID。
3.  **运行回测**: 重新运行 `python full_backtest.py` 和 `python generate_stock_reports.py`。
4.  **前端展示**: 刷新你的 Web 界面。你的新策略将自动出现在策略列表和统计中。
