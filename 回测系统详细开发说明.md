# 股票指标回测系统 - 详细开发说明

**版本**: 2.1.0
**更新日期**: 2026-01-09
**作者**: Manus AI

---

## 1. 系统概述

### 1.1. 功能与作用

股票指标回测系统（`tdx-strategy-backtest`）是一个基于 Python 和 React 的全栈量化交易策略回测平台。其核心作用是帮助投资者和研究人员验证各种技术指标策略在 A 股历史数据上的表现，从而评估策略的有效性、优化参数并做出更明智的投资决策。

系统实现了从数据获取、策略回测、结果分析到前端可视化展示的完整闭环，主要功能包括：

- **自动化数据下载**：从网络数据源（efinance, akshare）下载完整的 A 股日线历史行情数据。
- **多策略回测引擎**：支持多种内置技术指标策略，包括六脉神剑、买卖点、摇钱树以及缠论买点（一、二、三买）。
- **多维度数据分析**：对回测结果进行总数据、年度、月度三个维度的统计，计算胜率、平均收益、交易次数等关键指标。
- **可视化数据报告**：通过现代化的 Web 界面，以图表和表格的形式直观展示回测结果。
- **高度可扩展性**：系统设计允许方便地添加新的技术指标和交易策略。

### 1.2. 技术架构

项目采用**前后端分离**的架构，并通过**静态数据文件（JSON）**进行解耦。

- **后端 (Python)**：
  - **语言**: Python 3.11
  - **核心库**: Pandas, NumPy
  - **职责**: 负责数据下载、指标计算、策略回测，并将最终分析结果生成为 JSON 文件。

- **前端 (React)**：
  - **框架**: React 19 + Vite
  - **UI/样式**: Tailwind CSS 4, shadcn/ui, Recharts
  - **职责**: 读取后端生成的 JSON 数据，进行可视化展示和交互操作。

- **数据交换**：
  - Python 脚本将回测结果写入到 `web/client/src/data/` 目录下的 `.json` 文件中。
  - React 应用直接导入这些 JSON 文件作为其数据源，实现静态数据驱动。

### 1.3. 核心数据流

系统的核心数据流遵循一个清晰的管道模型：

```mermaid
graph TD
    A[互联网数据源] -->|efinance/akshare| B(py_file/stock_downloader_script.py);
    B -->|下载/更新| C{data/day/ (*.csv)};
    C -->|读取| D(py_file/full_backtest.py);
    D -->|计算指标/执行回测| E(py_file/indicators.py);
    D -->|生成| F{web/client/src/data/ (*.json)};
    F -->|导入| G[React 前端应用];
    G -->|渲染| H(仪表盘/回测系统/报告明细);
```

---

## 2. Python 后端系统详解

Python 后端位于 `py_file/` 目录下，是整个系统的数据处理和分析核心。

### 2.1. 关键脚本说明

| 脚本文件 | 主要作用 | 数据来源 | 处理流程 | 输出文件 |
| :--- | :--- | :--- | :--- | :--- |
| `stock_downloader_script.py` | **数据下载** | efinance, akshare | 获取全市场股票代码，下载或更新日线数据，按市场分类存储。 | `data/day/` 下的 CSV 文件 |
| `full_backtest.py` | **核心回测引擎** | `data/day/` 下的 CSV | 1. 加载所有股票数据<br>2. 计算所有技术指标<br>3. 遍历所有策略，执行回测<br>4. 计算多维度统计数据<br>5. 生成报告明细 | `backtest_results.json`<br>`stock_reports.json` |
| `indicators.py` | **技术指标库** | (被调用) | 提供所有技术指标（六脉、买卖点、缠论等）的数学计算函数。 | (无) |
| `generate_web_data.py` | **快速数据生成** | `data/day/` 下的 CSV | `full_backtest.py` 的简化版，用于快速生成报告，数据不完整。 | `stock_reports.json` |
| `test_sell_points.py` | **卖点专项测试** | `data/day/` 下的 CSV | 专门测试不同持有天数对策略收益的影响。 | 更新 `backtest_results.json` |

### 2.2. `full_backtest.py` 核心逻辑

这是系统最重要的脚本，其执行流程如下：

1.  **`main()` 函数**: 
    - 定义所有需要回测的策略列表 `signal_types`，包括六脉神剑、买卖点、摇钱树和新增的缠论一、二、三买。
    - 遍历每个策略，调用 `run_backtest()` 执行回测。
    - 对每个策略的回测结果，调用 `calculate_statistics()` 计算统计数据。
    - 调用 `find_optimal_hold_period()` 寻找最优持有周期。
    - 将所有结果汇总，并添加月度汇总统计 `monthly_stats` 和回测结论 `conclusions`。
    - 将最终数据结构写入 `backtest_results.json`。
    - 调用 `generate_stock_report()` 生成个股报告明细，并写入 `stock_reports.json`。

2.  **`load_stock_data(stock_code)` 函数**: 
    - **(已修复)** 使用 `encoding='utf-8-sig'` 读取 CSV 文件，以正确处理文件头的 BOM 字符，解决了大量文件无法正确解析列名的问题。
    - 在 `sh/`, `sz/`, `bj/` 等子目录中查找对应的股票代码文件。
    - 将 `日期` 列转换为 `datetime` 对象，并统一列名为 `open`, `close`, `high`, `low`, `volume`。

3.  **`run_backtest(signal_type, hold_days)` 函数**:
    - 使用 `DATA_DIR.rglob("*.csv")` 递归查找所有股票数据文件。
    - **(已修复)** 对加载的数据进行判断，仅当数据行数大于等于100时才进行回测，以保证统计意义。数据不足的股票将被跳过。
    - 对每只股票调用 `calculate_all_indicators()` 计算全量指标。
    - 调用 `find_signals()` 找到符合当前策略的买入信号。
    - 对每个信号，调用 `calculate_trade_result()` 计算交易结果（收益、胜负等）。

### 2.3. `indicators.py` 策略完善

- **(已完善)** 新增 `calculate_chan_theory()` 函数，用于计算缠论买点。
- 该函数实现了**缠论一买、二买、三买**的识别逻辑，基于笔结构、均线和分型进行判断。
- `full_backtest.py` 已集成此函数，并将三个缠论买点作为独立策略纳入全量回测范围。

---

## 3. Web 前端系统详解

Web 前端位于 `web/` 目录下，负责将后端生成的复杂数据以用户友好的方式呈现。

### 3.1. 网页与数据来源

| 网页/组件 | 访问路径 | 功能说明 | 主要数据来源 |
| :--- | :--- | :--- | :--- |
| `Home.tsx` | `/` | **仪表盘**：系统概览、核心特点、精选策略展示。 | `strategies.json`, `backtest_results.json` |
| `Backtest.tsx` | `/backtest` | **回测数据验证**：展示总/年度/月度回测统计，策略排行榜。 | `backtest_results.json` |
| `ReportDetail.tsx` | `/report-detail` | **报告明细**：以表格形式展示所有个股的回测数据，支持搜索、排序、分页和导出。 | `stock_reports.json` |
| `Strategies.tsx` | `/strategies` | **指标方案**：详细介绍所有单指标和组合策略。 | `strategies.json` |
| `Indicators.tsx` | `/indicators` | **指标详解**：解释各技术指标的计算原理和使用方法。 | (静态内容) |

### 3.2. `ReportDetail.tsx` 功能优化

此页面是数据展示的核心，已完成以下功能优化：

1.  **分页功能 (已实现)**:
    - **状态管理**: 使用 `useState` 管理 `currentPage` (当前页码) 和 `pageSize` (每页条数)。
    - **分页逻辑**: 通过 `filteredReports.slice()` 实现对数据的客户端分页。
    - **UI 组件**: 在表格下方添加了分页控件，包括页码跳转、上一页/下一页、首页/尾页按钮，以及每页显示条数的选择器（20/50/100/200）。

2.  **股价涨跌可视化 (已实现)**:
    - **(已修复)** 根据中国股市习惯，对收益率相关的列（总收益、年收益、月收益）进行了颜色区分。
    - **涨 (正收益)**: 文本颜色设为红色 (`text-red-400`) 并加粗。
    - **跌 (负收益)**: 文本颜色设为绿色 (`text-green-500`)。
    - **胜率**: 为突出显示，胜率文本颜色设为黄色 (`text-yellow-400`)。

### 3.3. `Backtest.tsx` 报错问题

- **(已修复)** 页面报错的根源在于 `backtest_results.json` 的数据结构与前端组件期望的不一致。
- **问题**: 缺少 `type` (策略类型) 和 `best_hold_days` (最优持有天数) 字段，同时顶层缺少 `monthly_stats` 和 `conclusions` 字段。
- **解决方案**: 已修改 `full_backtest.py`，在生成 JSON 文件时补全了所有缺失的字段，确保了数据结构的完整性和一致性。

---

## 4. 数据处理疑问解答

### **问题：`data/` 目录下存有全部股票数据（约5790条），但回测仅处理了491条，原因为何？**

经过排查，这个问题由两个核心原因导致：

1.  **CSV 文件编码问题 (主要原因)**
    - **现象**: 大部分从数据源下载的 CSV 文件头部包含一个不可见的 **UTF-8 BOM (Byte Order Mark)** 字符。
    - **影响**: 当 `pandas.read_csv()` 使用默认编码读取时，它无法正确识别第一列的列名 (`日期`)，导致列名被解析为 `\ufeff日期`，进而使得后续所有基于列名的操作失败，`load_stock_data` 函数返回 `None`。
    - **解决方案**: 在 `load_stock_data` 函数中，明确指定 `encoding='utf-8-sig'`。这个编码格式会自动检测并处理文件头部的 BOM，从而正确解析列名。

2.  **数据行数过滤**
    - **现象**: `run_backtest` 函数中存在 `if len(df) < 100: continue` 的逻辑。
    - **影响**: 对于上市时间较短或数据不完整的股票（数据行数少于100行），系统会直接跳过回测。这本身是合理的数据清洗步骤，以保证回测的统计有效性。
    - **解决方案**: 保留了此过滤逻辑，但明确了这是设计使然。同时，在文档中说明，数据量过少的股票不参与回测，但会在未来版本中考虑在报告中列出这些被跳过的股票及其原因。

**总结**：通过修复文件编码问题，回测系统现在能够正确加载并处理 `data/day/` 目录下的**全部**符合数据量要求的股票（约5000+），彻底解决了数据利用率不足的问题。

---

## 5. 部署与整合

### **Vercel 部署整合**

- **(已确认)** 项目的 Web 部分已经配置为单一项目部署。`web/vercel.json` 文件表明该项目使用 Vercel 进行部署，并且所有前端页面（包括仪表盘）都已在同一个 React 应用中，由 `App.tsx` 中的路由统一管理。
- **结论**: **无需进行额外的整合工作**。当前架构已经是集中部署的最佳实践，避免了功能分散。

---

## 6. 安装与运行指南

请严格按照以下步骤在本地环境设置和运行系统。

### 6.1. 环境要求
- Python 3.10+
- Node.js 18+ & pnpm

### 6.2. 后端设置

```bash
# 1. 克隆项目
gh repo clone zdsy-aa/tdx-strategy-backtest
cd tdx-strategy-backtest

# 2. 创建并激活 Python 虚拟环境
python3 -m venv venv
source venv/bin/activate

# 3. 安装 Python 依赖
pip install -r requirements.txt
```

### 6.3. 数据准备与回测

```bash
# 进入 Python 脚本目录
cd py_file

# 4. 下载股票历史数据 (首次运行耗时较长)
python stock_downloader_script.py

# 5. 执行完整回测 (此步骤计算量大，耗时较长)
python full_backtest.py
```

### 6.4. 前端设置与启动

```bash
# 回到项目根目录，进入 web 目录
cd ../web

# 6. 安装前端依赖
pnpm install

# 7. 启动开发服务器
pnpm dev
```

启动后，在浏览器中打开 `http://localhost:5173` 即可访问系统。
