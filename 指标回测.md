# 通达信指标回测系统 - Windows 本地操作手册

> **版本**: 2.0.0  
> **更新日期**: 2026-01-07  
> **适用系统**: Windows 10/11

---

## 目录

1. [项目简介](#1-项目简介)
2. [环境准备](#2-环境准备)
3. [项目下载](#3-项目下载)
4. [数据下载](#4-数据下载)
5. [运行回测](#5-运行回测)
6. [启动Web界面](#6-启动web界面)
7. [常见问题](#7-常见问题)
8. [项目结构说明](#8-项目结构说明)

---

## 1. 项目简介

本项目是一个基于通达信技术指标的股票回测系统，主要功能包括：

- **六脉神剑指标**: MACD、KDJ、RSI、LWR、BBI、MTM 六指标共振系统
- **买卖点指标**: 庄家线与散户线交叉系统
- **黄金摇钱树**: 三重过滤选股系统
- **缠论买点**: 笔结构买点识别

### 核心功能

| 功能模块 | 说明 |
|---------|------|
| 数据下载 | 支持下载全A股历史日线数据（从1990年至今） |
| 指标计算 | 严格按照通达信公式实现各类技术指标 |
| 策略回测 | 支持单指标和组合指标的历史回测 |
| 统计分析 | 区分总数据、年度数据、月度数据的胜率和收益统计 |
| Web界面 | 提供可视化的策略管理和回测报告界面 |

---

## 2. 环境准备

### 2.1 安装 Python

1. 下载 Python 3.11 或更高版本：https://www.python.org/downloads/
2. 安装时**务必勾选** "Add Python to PATH"
3. 验证安装：
   ```cmd
   python --version
   ```
   应显示 `Python 3.11.x` 或更高版本

### 2.2 安装 Node.js

1. 下载 Node.js 18 或更高版本：https://nodejs.org/
2. 选择 LTS 版本安装
3. 验证安装：
   ```cmd
   node --version
   npm --version
   ```

### 2.3 安装 Git

1. 下载 Git：https://git-scm.com/download/win
2. 使用默认选项安装
3. 验证安装：
   ```cmd
   git --version
   ```

### 2.4 安装 pnpm（可选，推荐）

```cmd
npm install -g pnpm
```

---

## 3. 项目下载

### 3.1 克隆项目

打开命令提示符（CMD）或 PowerShell，执行：

```cmd
# 进入你想存放项目的目录
cd D:\Projects

# 克隆项目
git clone https://github.com/zdsy-aa/tdx-strategy-backtest.git

# 进入项目目录
cd tdx-strategy-backtest
```

### 3.2 创建 Python 虚拟环境

```cmd
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate

# 安装 Python 依赖
pip install -r requirements.txt
```

如果没有 `requirements.txt`，手动安装依赖：

```cmd
pip install pandas numpy akshare requests
```

### 3.3 安装 Web 依赖

```cmd
# 进入 web 目录
cd web

# 安装依赖（使用 pnpm）
pnpm install

# 或使用 npm
npm install
```

---

## 4. 数据下载

### 4.1 下载全部 A 股数据

```cmd
# 确保在项目根目录，且虚拟环境已激活
cd D:\Projects\tdx-strategy-backtest
venv\Scripts\activate

# 进入 py_file 目录
cd py_file

# 下载全部 A 股数据（截止到 2026-01-06）
python download_all_a_stocks.py --end 20260106
```

**参数说明**：

| 参数 | 说明 | 示例 |
|------|------|------|
| `--end` | 截止日期 | `--end 20260106` |
| `--start` | 开始日期 | `--start 19900101` |
| `--limit` | 限制下载数量（测试用） | `--limit 100` |
| `--resume` | 断点续传模式 | `--resume` |

### 4.2 下载指定股票

```cmd
# 下载单只股票
python data_fetcher.py --stock 000001

# 下载指数
python data_fetcher.py --index sh000300
```

### 4.3 更新当天数据

```cmd
python data_fetcher.py --today
```

### 4.4 数据存储位置

下载的数据保存在 `data/day/` 目录下，每只股票一个 CSV 文件：

```
data/
└── day/
    ├── 000001.csv
    ├── 000002.csv
    ├── 600519.csv
    └── ...
```

---

## 5. 运行回测

### 5.1 快速回测

```cmd
# 确保在 py_file 目录
cd py_file

# 运行快速回测（使用2015年以后的数据）
python quick_backtest.py
```

### 5.2 完整回测

```cmd
# 运行完整回测（使用所有历史数据）
python full_backtest.py
```

### 5.3 卖出点测试

```cmd
# 测试不同卖出条件的效果
python test_sell_points.py
```

### 5.4 回测结果

回测结果保存在 `data/backtest_results/` 目录：

| 文件 | 说明 |
|------|------|
| `backtest_results.json` | 各策略回测统计 |
| `stock_reports.json` | 股票报告明细 |
| `sell_point_test_results.json` | 卖出点测试结果 |

---

## 6. 启动 Web 界面

### 6.1 开发模式

```cmd
# 进入 web 目录
cd web

# 启动开发服务器
pnpm dev
# 或
npm run dev
```

访问 http://localhost:5173 查看界面

### 6.2 生产模式

```cmd
# 构建生产版本
pnpm build
# 或
npm run build

# 预览生产版本
pnpm preview
# 或
npm run preview
```

### 6.3 Web 界面功能

| 页面 | 功能 |
|------|------|
| 首页 | 系统概览和快速入口 |
| 指标方案 | 查看和管理各类指标策略 |
| 回测数据 | 查看回测结果，支持总/年/月数据切换 |
| 报告明细 | Excel 样式的股票报告明细表 |
| 自定义策略 | 自由组合指标构建策略 |
| AI 优化 | AI 辅助策略优化 |

---

## 7. 常见问题

### Q1: pip 安装依赖失败

**解决方案**：使用国内镜像源

```cmd
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pandas numpy akshare requests
```

### Q2: akshare 获取数据失败

**可能原因**：
- 网络问题
- API 限流

**解决方案**：
1. 检查网络连接
2. 使用 `--resume` 参数断点续传
3. 增加请求间隔（修改脚本中的 `REQUEST_DELAY`）

### Q3: Node.js 安装依赖失败

**解决方案**：使用淘宝镜像

```cmd
npm config set registry https://registry.npmmirror.com
npm install
```

### Q4: 虚拟环境激活失败

**PowerShell 用户**：

```powershell
# 允许执行脚本
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 然后激活
venv\Scripts\Activate.ps1
```

### Q5: 端口被占用

**解决方案**：修改端口

```cmd
# 查找占用端口的进程
netstat -ano | findstr :5173

# 终止进程
taskkill /PID <进程ID> /F

# 或使用其他端口启动
pnpm dev -- --port 3000
```

---

## 8. 项目结构说明

```
tdx-strategy-backtest/
├── data/                      # 数据目录
│   ├── day/                   # 日线数据
│   │   ├── 000001.csv
│   │   └── ...
│   └── backtest_results/      # 回测结果
│       ├── backtest_results.json
│       └── stock_reports.json
│
├── py_file/                   # Python 脚本
│   ├── indicators.py          # 指标计算模块
│   ├── data_fetcher.py        # 数据下载模块
│   ├── download_all_a_stocks.py  # 全A股下载脚本
│   ├── quick_backtest.py      # 快速回测脚本
│   ├── full_backtest.py       # 完整回测脚本
│   └── test_sell_points.py    # 卖出点测试脚本
│
├── web/                       # Web 界面
│   ├── client/                # 前端代码
│   │   ├── src/
│   │   │   ├── pages/         # 页面组件
│   │   │   ├── components/    # 通用组件
│   │   │   └── data/          # 静态数据
│   │   └── package.json
│   └── server/                # 后端代码
│
├── venv/                      # Python 虚拟环境（本地创建）
├── requirements.txt           # Python 依赖
├── README.md                  # 项目说明
└── 指标回测.md                # 本操作手册
```

---

## 附录：快速命令参考

```cmd
# 1. 激活虚拟环境
venv\Scripts\activate

# 2. 下载全部数据
cd py_file && python download_all_a_stocks.py --end 20260106

# 3. 运行回测
python quick_backtest.py

# 4. 启动 Web
cd ..\web && pnpm dev

# 5. 退出虚拟环境
deactivate
```

---

## 联系与支持

- **GitHub**: https://github.com/zdsy-aa/tdx-strategy-backtest
- **Issues**: https://github.com/zdsy-aa/tdx-strategy-backtest/issues

如有问题，欢迎提交 Issue 或 Pull Request。

---

## 9. 数据下载备选方案 (手动下载)

如果自动下载脚本因网络问题无法工作，您可以尝试手动下载数据包：

### 推荐数据源
1.  **Tushare 官网**: [https://tushare.pro/](https://tushare.pro/) (需注册)
2.  **Kaggle 数据集**: 搜索 "China Stock Market Data"
3.  **网易财经/新浪财经**: 提供单只股票的历史数据 CSV 下载

### 数据格式要求
请确保下载的 CSV 文件满足以下要求：
*   **文件名**: 股票代码.csv (例如 `000001.csv`)
*   **包含列**: `日期`, `开盘`, `收盘`, `最高`, `最低`, `成交量` (列名需对应，或修改代码适配)

### 上传位置
将下载的 CSV 文件放入项目的 `data/day/` 目录下即可。系统会自动识别该目录下的所有 CSV 文件进行回测。
