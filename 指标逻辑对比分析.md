# 指标逻辑对比分析报告

## 一、通达信指标代码概览

### 1. 六脉神剑 (六脉神剑.txt)

**核心逻辑**：
- 6个指标共振系统：MACD、KDJ、RSI、LWR、BBI、MTM
- 每个指标都有独立的多空判断
- 当所有6个指标同时看多时，产生买入信号

**关键条件**：
```
涨买入: IF(X_5 AND X_10 AND X_15 AND X_20 AND X_23 AND X_29 
        AND REF(X_5 AND X_10 AND X_15 AND X_20 AND X_23 AND X_29,1)=0,6,0)
```

其中：
- X_5: MACD金叉 (EMA(CLOSE,8)-EMA(CLOSE,13) > EMA(X_3,5))
- X_10: KDJ金叉 (X_8 > X_9)
- X_15: RSI金叉 (X_13 > X_14)
- X_20: LWR金叉 (X_18 > X_19)
- X_23: BBI多头 (CLOSE > X_22)
- X_29: MTM金叉 (X_27 > X_28)

**Python 对应函数**: `calculate_six_veins()`

---

### 2. 买卖点 (买卖点.txt)

**核心逻辑**：
- 两条线：庄家线 (EMA(J,6)) 和 散户线 (100*(HHV(HIGH,M)-CLOSE)/(HHV(HIGH,M)-LLV(LOW,M)))
- 第一买点：CROSS(14, 吸筹) - 吸筹指标上穿14
- 第二买点：CROSS(庄家, 散户) AND 庄家<50 - 庄家线上穿散户线且庄家线低于50

**关键参数**：
- M = 55
- N = 34

**Python 对应函数**: `calculate_buy_sell_points()`

---

### 3. 缠论 (缠论.txt)

**核心逻辑**：
使用通达信的 TDXDLL4 函数进行笔结构识别，然后根据笔的方向和高低点序列判断买卖点。

**一买逻辑**：
```
一买TJ1 := 方向 = 1 AND L < MA13 AND LL1 <= 5
一五段下跌 := DD1 < GG1 AND DD1 < DD2 AND DD1 < DD3 AND GG1 < GG2 AND GG1 < GG3
一买A := 一买TJ1 AND 一五段下跌 AND 一买TJA
```

**二买逻辑**：
```
买TJ1 := 方向 = 1 AND L < MA26 AND LL1 <= 8
二买TJ := DD1 < GG1 AND DD1 > DD2
三段下跌 := GG3 > GG2 AND DD3 > DD2
二买A := 买TJ1 AND 二买TJ AND 三段下跌 AND 二买TJA1
```

**三买逻辑**：
```
三买TJ := DD1 < GG1 AND DD1 > DD2
三买TJA1 := 方向 = 1 AND L < MA13 AND LL1 <= 5
三买TJA2 := DD1 > MIN(GG2, GG3) AND GG3 > DD2 AND DD4 < MAX(DD2, DD3) AND DD1 > DD4
三买1 := 三买TJ AND 三买TJA1 AND 三买TJA2
```

**Python 对应函数**: `calculate_chan_theory()`

---

### 4. 黄金摇钱树 (黄金摇钱树.txt)

**核心逻辑**：
三重过滤系统：
1. XG55: 底部形态确认 (COUNT(底>0,5)>=1)
2. XG66: 均线交叉 (CROSS(A2,A1) AND REF(C,1)>REF(C,2)*1.025 AND C<REF(C,1))
3. XG88: KDJ或VAR2指标交叉 (COUNT(XG77>0,5)>=1)

**最终信号**：
```
XG: XG66 AND XG55 AND XG88
```

**Python 对应函数**: `calculate_money_tree()`

---

## 二、Python 实现对比

### 需要核对的关键点：

1. **六脉神剑**：
   - ✅ 6个指标的计算公式是否与通达信一致
   - ✅ 共振条件是否正确（所有指标同时看多）
   - ⚠️ 需要确认 `six_veins_count` 的计数逻辑

2. **买卖点**：
   - ✅ 庄家线和散户线的计算公式
   - ⚠️ 吸筹指标的复杂计算逻辑
   - ⚠️ 买点1和买点2的触发条件

3. **缠论**：
   - ❌ **重大问题**：Python 实现使用简化的分型识别，而通达信使用 TDXDLL4 笔结构
   - ❌ 高低点序列 (GG1-GG5, DD1-DD5) 的计算方式完全不同
   - ❌ 买点判断条件可能不一致

4. **黄金摇钱树**：
   - ⚠️ 顶底形态识别的复杂逻辑
   - ⚠️ SUMBARS、LLVBARS、HHVBARS 等通达信特有函数的实现

---

## 三、发现的主要问题

### 🔴 **严重不一致：缠论指标**

**通达信实现**：
- 使用 TDXDLL4 函数进行专业的笔结构识别
- 基于笔的方向和高低点序列进行复杂判断
- 有完整的一买、二买、三买、强二买、类二买逻辑

**Python 实现**：
```python
def calculate_chan_theory(df):
    # 简化实现：基于分型识别
    df['chan_buy1'] = (df['bottom_fractal']) & (df['close'] < df['ma13']) & (df['close'] < df['close'].shift(1))
    df['chan_buy2'] = (df['close'] < df['ma26']) & (df['close'] > df['close'].rolling(5).min())
    df['chan_buy3'] = (df['close'] > df['ma13']) & (df['close'] > df['close'].rolling(5).min())
```

**结论**：Python 实现过于简化，与通达信逻辑完全不同。

---

### 🟡 **需要验证：六脉神剑**

通达信代码显示需要6个指标同时满足条件，且前一天不满足（首次出现）。

Python 需要确认：
- `six_veins_count` 是否正确统计了6个指标
- 是否需要添加"首次出现"的判断

---

### 🟡 **需要验证：买卖点**

通达信的吸筹指标计算非常复杂：
```
VAR3:=SMA(ABS(LOW-VAR2),3,1)/SMA(MAX(LOW-VAR2,0),3,1)*100*VAR1
VAR4:=EMA(IF(CLOSE*1.3,VAR3*10,VAR3/10),3)*VAR1
VAR8:=EMA(IF(LOW<=VAR5,(VAR4+VAR6*2)/2,0),3)/618*VAR7*VAR1
```

需要逐行核对 Python 实现。

---

### 🟡 **需要验证：黄金摇钱树**

通达信使用了多个特殊函数：
- SUMBARS: 累加到指定值的周期数
- LLVBARS: 最低值位置
- HHVBARS: 最高值位置

需要确认 Python 是否正确实现了这些函数。

---

## 四、建议修复方案

### 优先级1：缠论指标（必须重写）

**方案A**：完整实现笔结构识别算法
- 实现去包含逻辑
- 实现分型识别
- 实现笔的确认
- 实现高低点序列追踪

**方案B**：使用第三方缠论库
- 寻找现有的 Python 缠论实现
- 集成到项目中

**方案C**：简化但保持逻辑一致
- 保留核心判断条件（方向、MA13/MA26、LL1/HH1）
- 简化笔结构识别为趋势判断

### 优先级2：验证六脉神剑

1. 逐个核对6个指标的计算公式
2. 确认共振条件的实现
3. 添加"首次出现"判断（如需要）

### 优先级3：验证买卖点

1. 核对庄家线和散户线公式
2. 详细核对吸筹指标的每一步计算
3. 确认买点触发条件

### 优先级4：验证黄金摇钱树

1. 实现 SUMBARS、LLVBARS、HHVBARS 函数
2. 核对顶底形态识别逻辑
3. 验证三重过滤条件

---

## 五、下一步行动

1. **立即修复**：缠论指标（影响最大）
2. **详细核对**：六脉神剑、买卖点、黄金摇钱树
3. **回测验证**：修复后重新运行回测，对比结果
4. **文档更新**：更新开发文档，说明指标实现细节

---

**报告生成时间**: 2026-01-09
**分析人员**: Manus AI
