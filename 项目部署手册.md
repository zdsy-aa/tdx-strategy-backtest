# TDX 策略回测系统 - 终极部署手册 (小白友好版)

> **版本**: 4.0.1  
> **更新日期**: 2026-01-11
> **目标读者**: 任何对本项目感兴趣，但可能不具备深厚编程背景的朋友。

---

## 前言

你好！欢迎使用 TDX 策略回测系统。这份手册将手把手地带你完成从零到一的整个部署过程。无论你是 Windows 用户还是 Linux 用户，只要跟着步骤走，即使是第一次接触代码，也能成功运行本项目。

我们将分为两大章节，请根据你的操作系统选择对应的章节阅读：

*   **第一章：Windows 平台部署指南**
*   **第二章：Linux (Ubuntu) 平台部署指南**

让我们开始吧！

---

## 第一章：Windows 平台部署指南

本章节专门为 Windows 10 和 Windows 11 用户编写。

### 第1步：安装必备软件 (Git, Python, Node.js)

在开始之前，我们需要安装三个基础软件。如果你的电脑上已经安装过，可以跳到下一步。

#### 1.1 安装 Git (代码版本管理工具)

*   **作用**: 用来从 GitHub 上下载 (克隆) 项目代码。
*   **下载地址**: [https://git-scm.com/download/win](https://git-scm.com/download/win)
*   **安装步骤**:
    1.  打开下载地址，网站会自动为你下载合适的安装包。
    2.  双击运行安装包，一路点击 “Next” 使用默认设置即可。
*   **验证安装**:
    1.  在桌面点击鼠标右键，如果看到菜单里出现了 “Git Bash Here” 或 “Open Git Bash here”，说明安装成功。

#### 1.2 安装 Python (后端运行环境)

*   **作用**: 用来运行项目的数据下载和策略回测脚本。
*   **下载地址**: [https://www.python.org/downloads/](https://www.python.org/downloads/)
*   **安装步骤**:
    1.  打开下载地址，点击 “Download Python 3.x.x” (x代表版本号，推荐 3.11 或更高)。
    2.  双击运行安装包。
    3.  **【极其重要】** 在安装界面的最下方，**务必勾选 “Add Python to PATH”** 这个选项！
    4.  点击 “Install Now” 进行安装。
*   **验证安装**:
    1.  按下 `Win` + `R` 键，输入 `cmd` 并回车，打开命令提示符。
    2.  输入 `python --version` 并回车。如果显示出 Python 的版本号，说明安装成功。

#### 1.3 安装 Node.js (前端运行环境)

*   **作用**: 用来运行和构建项目的前端网页界面。
*   **下载地址**: [https://nodejs.org/](https://nodejs.org/)
*   **安装步骤**:
    1.  打开下载地址，选择左侧的 “LTS” (长期支持) 版本进行下载。
    2.  双击运行安装包，一路点击 “Next” 使用默认设置即可。
*   **验证安装**:
    1.  同样在命令提示符 (`cmd`) 中，输入 `node --version` 并回车。
    2.  再输入 `npm --version` 并回车。如果都显示版本号，说明安装成功。

### 第2步：下载项目与配置环境

#### 2.1 下载 (克隆) 项目代码

1.  找一个你喜欢的位置用来存放项目，例如 `D:\tdx-project`。
2.  在该文件夹内，点击鼠标右键，选择 “Git Bash Here” 打开 Git 终端。
3.  在弹出的黑色窗口中，输入以下命令并回车：
    ```bash
    gh repo clone zdsy-aa/tdx-strategy-backtest
    ```
4.  等待下载完成。完成后，你会看到一个名为 `tdx-strategy-backtest` 的新文件夹。

#### 2.2 配置后端 (Python) 环境

1.  **进入项目目录**: 在刚才的 Git Bash 窗口中，输入以下命令进入项目文件夹：
    ```bash
    cd tdx-strategy-backtest
    ```
2.  **创建并激活虚拟环境**: 这是一个独立、干净的 Python 环境，可以避免库版本冲突。
    ```bash
    # 创建虚拟环境
    python -m venv venv

    # 激活虚拟环境 (注意这里的路径)
    source venv/Scripts/activate
    ```
    激活成功后，你会看到命令行前面出现了 `(venv)` 的字样。

3.  **安装 Python 依赖库**: 这些是项目后端运行所必需的库。
    ```bash
    # 如果网络好，直接运行
    pip install -r requirements.txt

    # 如果下载慢，使用国内镜像源
    # pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
    ```

#### 2.3 配置前端 (Node.js) 环境

1.  **安装 pnpm**: 这是一个更快、更高效的包管理工具。在 Windows 上，`npm install -g pnpm` 命令可能会因为权限问题报错。请按照以下步骤操作：
    *   **方法一：使用管理员权限 (推荐)**
        1.  点击 Windows 开始菜单，搜索 **“CMD”** 或 **“命令提示符”**。
        2.  在搜索结果上点击鼠标右键，选择 **“以管理员身份运行”**。
        3.  在打开的黑色窗口中输入：`npm install -g pnpm` 并回车。

    *   **方法二：使用 `corepack` (Node.js 自带)**
        如果方法一依然报错，或者你希望使用 Node.js 官方推荐的方式，可以尝试 `corepack`。
        1.  同样以管理员身份打开 CMD。
        2.  输入：`corepack enable` 并回车。
        3.  输入：`pnpm --version` 并回车，验证 pnpm 是否安装成功。

    **【重要提示】**：请务必确保 pnpm 安装成功，否则后续前端依赖安装会失败。

2.  **进入前端目录并安装依赖**: 
    ```bash
    # 进入 web 目录
    cd web

    # 安装依赖
    pnpm install

    # 【重要】初次运行前，请先执行一次构建
    pnpm build
    ```
    **【重要提示】**：如果 `pnpm install` 报错，请检查 pnpm 是否已正确安装 (参考上一步)。

3.  **返回项目根目录**: 
    ```bash
    cd ..
    ```

### 第3步：运行项目

现在，万事俱备，只欠东风！

#### 3.1 准备数据 (关键步骤)

在看漂亮的网页之前，我们必须先让后端脚本把数据准备好。

1.  **确保虚拟环境已激活**: 检查命令行前面是否有 `(venv)`。
2.  **进入 Python 脚本目录**: 
    ```bash
    cd py_file
    ```
3.  **下载股票数据**: 
    ```bash
    # 第一次运行时，需要下载全部数据，耗时较长 (约30-60分钟)，请耐心等待
    python stock_downloader.py --full
    ```
4.  **运行回测并生成报告**: 
    ```bash
    # 这两个脚本现在是并行化的，会利用你电脑的所有CPU核心，速度很快
    python full_backtest.py
    python generate_stock_reports.py
    ```

#### 3.2 启动前端网页

1.  **回到项目根目录**: 
    ```bash
    cd ..
    ```
2.  **进入前端目录**: 
    ```bash
    cd web
    ```
3.  **启动开发服务器**: 
    ```bash
    pnpm dev
    ```
    > **注意**：如果报错 `No available port found`，说明 3000 端口被占用。系统会自动尝试其他端口，请留意终端输出的实际网址（如 `http://localhost:3001`）。

4.  **访问网页**: 终端会显示一个网址。在你的浏览器中打开这个地址，你就能看到回测系统的界面了！

---

## 第二章：Linux (Ubuntu) 平台部署指南
本章节专门为 Ubuntu 22.04 及以上版本的用户编写。

### 第1步：安装必备软件 (Git, Python, Node.js)

我们将使用 `apt` 包管理器来安装所有必需的软件。

1.  **打开终端**: 按下 `Ctrl` + `Alt` + `T`。
2.  **更新包列表并安装**: 
    ```bash
    # 更新系统包
    sudo apt update && sudo apt upgrade -y

    # 安装 Git, Python 3.11+, pip 和 venv
    sudo apt install -y git python3.11 python3-pip python3.11-venv
    ```
3.  **安装 Node.js (推荐使用 nvm)**: `nvm` 是一个优秀的 Node.js 版本管理器。
    ```bash
    # 下载并运行 nvm 安装脚本
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

    # 让 nvm 生效 (或者重启终端)
    source ~/.bashrc

    # 安装 Node.js 18
    nvm install 18
    nvm use 18
    ```
4.  **安装 pnpm**: 
    ```bash
    npm install -g pnpm
    ```

### 第2步：下载项目与配置环境

#### 2.1 下载 (克隆) 项目代码

1.  在终端中，进入你希望存放项目的目录，例如 `~/projects`。
2.  输入以下命令下载项目并进入目录：
    ```bash
    gh repo clone zdsy-aa/tdx-strategy-backtest
    cd tdx-strategy-backtest
    ```

#### 2.2 配置后端 (Python) 环境

1.  **创建并激活虚拟环境**: 
    ```bash
    # 创建虚拟环境
    python3 -m venv venv

    # 激活虚拟环境
    source venv/bin/activate
    ```
    激活成功后，命令行前面会出现 `(venv)`。

2.  **安装 Python 依赖库**: 
    ```bash
    # 如果网络好，直接运行
    pip install -r requirements.txt

    # 如果下载慢，使用国内镜像源
    # pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
    ```

#### 2.3 配置前端 (Node.js) 环境

1.  **进入前端目录并安装依赖**: 
    ```bash
    # 进入 web 目录
    cd web

    # 安装依赖
    pnpm install

    # 如果下载慢，先设置国内镜像源再安装
    # pnpm config set registry https://registry.npmmirror.com
    # pnpm install
    ```
2.  **返回项目根目录**: 
    ```bash
    cd ..
    ```

### 第3步：运行项目


#### 3.1 准备数据 (关键步骤)

1.  **确保虚拟环境已激活**: 检查命令行前面是否有 `(venv)`。
2.  **进入 Python 脚本目录**: 
    ```bash
    cd py_file
    ```
3.  **下载股票数据**: 
    ```bash
    # 第一次运行时，需要下载全部数据，耗时较长 (约30-60分钟)，请耐心等待
    python stock_downloader.py --full
    ```
4.  **运行回测并生成报告**: 
    ```bash
    # 这两个脚本现在是并行化的，会利用你电脑的所有CPU核心，速度很快
    python full_backtest.py
    python generate_stock_reports.py
    ```

#### 3.2 启动前端网页

1.  **回到项目根目录**: 
    ```bash
    cd ..
    ```
2.  **进入前端目录**: 
    ```bash
    cd web
    ```
3.  **启动开发服务器**: 
    ```bash
    pnpm dev
    ```
4.  **访问网页**: 终端会显示一个网址，通常是 `http://localhost:5173`。在你的浏览器中打开这个地址，你就能看到回测系统的界面了！

---

## 7. 常见问题 (FAQ)

*   **Q: `npm` 或 `node` 命令找不到 (Windows 环境下报错 `不是内部或外部命令`)？**
    *   **A:** 这通常是 Node.js 的环境变量没有正确配置。请尝试以下步骤：
        1.  **重启终端**：如果您刚刚安装完 Node.js，请**关闭所有**已经打开的黑窗口（CMD、PowerShell、Git Bash），然后**重新打开**一个。新打开的窗口会自动加载最新的环境变量。
        2.  **手动检查 Node.js 安装路径**：
            *   打开您的 Node.js 安装目录（默认通常是 `C:\Program Files\nodejs`）。
            *   确认该目录下是否有 `node.exe` 和 `npm.cmd` 文件。
            *   如果没有，说明 Node.js 安装失败，请重新运行安装包。
        3.  **手动添加环境变量 (终极方案)**：如果重启后依然报错，请按照以下步骤操作：
            *   在 Windows 搜索框输入 **“环境变量”**，选择 **“编辑系统环境变量”**。
            *   点击 **“环境变量”** 按钮。
            *   在 **“系统变量”** 栏找到 **“Path”**，双击打开。
            *   点击 **“新建”**，将 Node.js 的安装路径（如 `C:\Program Files\nodejs\`）粘贴进去。
            *   一路点击确定，然后**重启电脑**或**重启终端**。

*   **Q: `pip` 或 `pnpm` 安装失败/速度慢？**
    *   **A:** 大概率是网络问题。请参考本文档 [2.2 配置后端 (Python) 环境](#22-配置后端-python-环境) 和 [2.3 配置前端 (Node.js) 环境](#23-配置前端-nodejs-环境) 节中的提示，切换到国内镜像源。

*   **Q: 数据下载 (`stock_downloader.py`) 失败或中断？**
    *   **A:** `akshare` 接口可能因网络波动或API限流而出错。脚本设计有重试机制，但如果长时间失败，可以稍后再试。对于全量下载，如果中断，可以再次运行，脚本会跳过已下载的文件。

*   **Q: Web 界面显示空白或数据陈旧？**
    *   **A:** 请确保你已经成功运行了第 [3.1 准备数据 (关键步骤)](#31-准备数据-关键步骤) 节中的所有回测脚本，特别是 `full_backtest.py` 和 `generate_stock_reports.py`，因为 Web 界面的所有数据都来源于它们生成的 JSON 文件。

*   **Q: PowerShell 中激活虚拟环境失败？**
    *   **A:** PowerShell 默认禁止执行脚本。请以管理员身份运行 PowerShell，执行 `Set-ExecutionPolicy RemoteSigned`，然后选择 `Y`。之后即可正常使用 `venv\Scripts\Activate.ps1` 激活环境。

---

## 8. 项目结构说明


```
tdx-strategy-backtest/
├── data/                      # 数据中心
│   └── day/                   # 股票日线数据 (按市场分子目录 sh, sz, bj)
├── py_file/                   # Python 后端核心脚本
│   ├── stock_downloader.py    # 数据下载器
│   ├── indicators.py          # 指标计算引擎
│   ├── full_backtest.py       # 策略回测主脚本
│   ├── generate_stock_reports.py # 生成个股报告脚本
│   ├── update_web_data.py     # 数据同步脚本
│   └── ...                    # 其他策略测试脚本
├── web/                       # 前端应用 (Vite + React)
│   ├── client/src/            # 前端源码
│   │   ├── pages/             # 页面组件
│   │   ├── components/        # 可复用组件
│   │   └── data/              # 回测数据 (JSON格式，供前端直接读取)
│   └── dist/                  # 前端构建后的静态文件目录
├── deploy/                    # 部署相关脚本和配置
├── venv/                      # Python 虚拟环境 (本地生成)
├── requirements.txt           # Python 依赖清单
├── 项目部署手册.md            # 本文档
└── 回测系统详细开发说明.md    # 开发者文档
```


---

## 附录：跨平台协作注意事项 (Windows 本地开发 + Vercel 部署)

为了确保您在 Windows 本地开发后提交的代码能够顺利在 Vercel (Linux 环境) 部署，我们引入了以下机制，并请您遵循以下开发流程：

### 1. 核心机制

*   **`.gitattributes`**: 确保 `pnpm-lock.yaml` 等关键文件在 Windows 和 Linux 之间保持相同的换行符 (LF)，从根源上避免了因换行符不一致导致的锁文件冲突。
*   **`.npmrc`**: 配置文件，确保 pnpm 在不同环境下的行为一致，并自动处理依赖关系。
*   **`package.json` 中的 `packageManager`**: 锁定 pnpm 版本，确保您本地和 Vercel 使用的 pnpm 版本完全一致。

### 2. Windows 本地开发流程

当您在本地需要**新增或更新依赖**时，请严格遵循以下步骤：

1.  **安装/更新依赖**：
    ```bash
    # 例如，新增一个依赖
    pnpm add some-new-package

    # 或者，更新所有依赖
    pnpm update
    ```

2.  **提交代码**：
    ```bash
    # 将所有更改添加到暂存区
    git add -A

    # 提交更改（请写清楚本次提交的内容）
    git commit -m "feat: 添加 some-new-package 依赖"

    # 推送到远程仓库
    git push origin main
    ```

**关键点**：只要您在本地执行了任何会修改 `package.json` 的 `pnpm` 命令，就**必须**将 `package.json` 和自动更新的 `pnpm-lock.yaml` 一起提交到 Git 仓库。这样，Vercel 在部署时就能获取到与您本地完全一致的依赖关系，从而避免报错。
