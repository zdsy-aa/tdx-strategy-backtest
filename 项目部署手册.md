# TDX 策略回测系统 - 跨平台部署手册

> **版本**: 3.0.0  
> **更新日期**: 2026-01-11
> **适用系统**: Windows 10/11, Linux (Ubuntu 22.04+), macOS

---

## 目录

1.  [项目简介](#1-项目简介)
2.  [环境准备](#2-环境准备)
    *   [2.1 Windows 环境](#21-windows-环境)
    *   [2.2 Linux (Ubuntu) 与 macOS 环境](#22-linux-ubuntu-与-macos-环境)
3.  [项目安装与配置](#3-项目安装与配置)
    *   [3.1 克隆项目](#31-克隆项目)
    *   [3.2 后端配置 (Python)](#32-后端配置-python)
    *   [3.3 前端配置 (Node.js)](#33-前端配置-nodejs)
4.  [核心流程：数据与回测](#4-核心流程数据与回测)
    *   [4.1 下载股票数据](#41-下载股票数据)
    *   [4.2 运行策略回测](#42-运行策略回测)
5.  [启动与访问](#5-启动与访问)
    *   [5.1 本地开发模式](#51-本地开发模式)
    *   [5.2 服务器生产部署 (Nginx)](#52-服务器生产部署-nginx)
6.  [自动化任务](#6-自动化任务)
    *   [6.1 Linux/macOS (systemd/cron)](#61-linuxmacos-systemdcron)
    *   [6.2 Windows (任务计划程序)](#62-windows-任务计划程序)
7.  [常见问题 (FAQ)](#7-常见问题-faq)
8.  [项目结构说明](#8-项目结构说明)

---

## 1. 项目简介

本项目是一个基于 Python 和 React 的全栈股票量化回测系统。它能够下载A股历史数据，运行多种技术指标策略（如六脉神剑、买卖点策略），并通过一个现代化的 Web 界面生成详细的可视化回测报告。

| 功能模块 | 说明 |
|---|---|
| **数据下载** | 支持全量、增量下载全市场A股历史日线数据。 |
| **指标计算** | 严格按照通达信公式实现 MACD, KDJ, RSI, BBI 等核心指标。 |
| **策略回测** | 支持单指标和组合指标的历史回测，并提供多维度统计。 |
| **统计分析** | 自动计算总、年、月维度的胜率、收益率、交易次数等。 |
| **Web 界面** | 提供可视化的策略管理、回测报告和股票明细仪表盘。 |

---

## 2. 环境准备

### 2.1 Windows 环境

1.  **安装 Python**: 
    *   访问 [Python 官网](https://www.python.org/downloads/) 下载 Python 3.11 或更高版本。
    *   安装时，**务必勾选 "Add Python to PATH"**。
    *   打开 CMD 或 PowerShell 验证: `python --version`

2.  **安装 Node.js**:
    *   访问 [Node.js 官网](https://nodejs.org/) 下载 18.x LTS 或更高版本。
    *   使用默认选项安装。
    *   验证: `node --version` 和 `npm --version`

3.  **安装 Git**:
    *   访问 [Git 官网](https://git-scm.com/download/win) 下载并安装。
    *   验证: `git --version`

4.  **安装 pnpm (推荐)**:
    *   在 CMD 或 PowerShell 中运行: `npm install -g pnpm`

### 2.2 Linux (Ubuntu) 与 macOS 环境

**对于 Ubuntu/Debian 系统:**

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装 Git, Python, pip 和 venv
sudo apt install -y git python3 python3-pip python3.venv

# 安装 Node.js (推荐使用 nvm)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm
```

**对于 macOS 系统 (使用 Homebrew):**

```bash
# 如果没有安装 Homebrew，先安装它
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装核心依赖
brew install python@3.11 node git pnpm
```

---

## 3. 项目安装与配置

### 3.1 克隆项目

打开终端或 CMD，进入你希望存放项目的目录，然后执行：

```bash
# 克隆项目
gh repo clone zdsy-aa/tdx-strategy-backtest

# 进入项目目录
cd tdx-strategy-backtest
```

### 3.2 后端配置 (Python)

在项目根目录下执行以下命令，创建并配置 Python 环境。

**Windows:**
```cmd
:: 创建虚拟环境
python -m venv venv

:: 激活虚拟环境
venv\Scripts\activate

:: 安装依赖
pip install -r requirements.txt
```

**Linux/macOS:**
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```
> **提示**: 如果 `pip` 安装速度慢，可以切换到国内镜像源: `pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt`

### 3.3 前端配置 (Node.js)

```bash
# 进入 web 目录
cd web

# 安装依赖 (推荐使用 pnpm)
pnpm install

# 如果没有 pnpm，可使用 npm
# npm install

# 返回项目根目录
cd ..
```
> **提示**: 如果 `pnpm` 或 `npm` 安装速度慢，可以切换到淘宝镜像源: `pnpm config set registry https://registry.npmmirror.com`

---

## 4. 核心流程：数据与回测

在启动 Web 界面前，必须先生成数据。请确保已激活 Python 虚拟环境 (`source venv/bin/activate` 或 `venv\Scripts\activate`)。

### 4.1 下载股票数据

数据下载是所有分析的基础。脚本支持全量和增量模式。

```bash
# 进入 Python 脚本目录
cd py_file

# 首次运行：执行全量下载 (耗时较长，约30-60分钟)
python stock_downloader.py --full

# 后续更新：执行增量下载 (仅更新数据)
# python stock_downloader.py --incremental
```

### 4.2 运行策略回测

下载数据后，运行回测脚本来生成前端所需的 JSON 报告。

```bash
# 确保在 py_file 目录下

# 1. 运行完整回测，生成策略统计数据
python full_backtest.py

# 2. 生成个股报告明细
python generate_stock_reports.py

# 3. (可选) 更新网页数据，确保所有数据同步
python update_web_data.py
```

执行完毕后，`web/client/src/data/` 目录下会生成 `backtest_results.json` 和 `stock_reports.json` 等文件，供前端使用。

---

## 5. 启动与访问

### 5.1 本地开发模式

适用于本地查看和开发。

```bash
# 确保在项目根目录的 web 文件夹下
cd web

# 启动开发服务器
pnpm dev
```

启动后，在浏览器中访问 `http://localhost:5173` 即可看到回测系统界面。

### 5.2 服务器生产部署 (Nginx)

适用于将系统部署到云服务器，提供公开访问。

1.  **构建前端应用**:
    ```bash
    # 在 web 目录下
pnpm build
    ```
    这会在 `web/dist` 目录下生成静态文件。

2.  **配置 Nginx**:
    在服务器上为你的域名或 IP 创建一个 Nginx 配置文件。
    ```bash
    sudo nano /etc/nginx/sites-available/tdx-backtest
    ```
    粘贴以下配置 (请将 `your_domain.com` 和 `/home/ubuntu` 替换为你的实际值):
    ```nginx
    server {
        listen 80;
        server_name your_domain.com; # 你的域名或服务器IP

        root /home/ubuntu/tdx-strategy-backtest/web/dist; # 前端构建文件的路径
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }
    }
    ```

3.  **启用配置并重启 Nginx**:
    ```bash
    # 启用站点
    sudo ln -s /etc/nginx/sites-available/tdx-backtest /etc/nginx/sites-enabled/

    # 测试配置语法
    sudo nginx -t

    # 重启 Nginx
    sudo systemctl restart nginx
    ```

---

## 6. 自动化任务

为了保持数据最新，可以设置定时任务，每天自动更新数据和回测报告。

### 6.1 Linux/macOS (systemd/cron)

项目 `deploy` 目录中提供了 `systemd` 配置文件，这是在现代 Linux 系统上推荐的方式。

```bash
# 进入部署目录
cd ~/tdx-strategy-backtest/deploy

# 运行安装脚本 (会自动复制 service 和 timer 文件并启动)
sudo ./install_timer.sh
```

**常用命令:**
*   查看定时器状态: `sudo systemctl status tdx-backtest-update.timer`
*   查看任务日志: `sudo journalctl -u tdx-backtest-update.service -f`

### 6.2 Windows (任务计划程序)

在 Windows 上，可以使用“任务计划程序”来实现自动化。

1.  **创建执行脚本**: 在项目根目录创建一个 `.bat` 批处理文件，例如 `run_update.bat`，内容如下：
    ```bat
    @echo off
    ECHO "Starting TDX Backtest Update Task..."
    
    :: 进入项目目录 (请修改为你的实际路径)
    cd /d D:\path\to\your\tdx-strategy-backtest
    
    :: 激活 Python 虚拟环境
    call .\venv\Scripts\activate
    
    :: 进入脚本目录
    cd py_file
    
    :: 执行增量数据下载
    python stock_downloader.py --incremental
    
    :: 重新生成报告
    python full_backtest.py
    python generate_stock_reports.py
    python update_web_data.py
    
    :: 退出虚拟环境
    deactivate
    
    ECHO "Update Task Finished."
    ```

2.  **设置任务计划程序**:
    *   打开“任务计划程序”。
    *   点击“创建基本任务”，设置一个名称（如 “TDX Daily Update”）。
    *   设置触发器为“每天”，并选择一个合适的执行时间（如凌晨 2:00）。
    *   设置操作为“启动程序”，在“程序或脚本”中选择你刚刚创建的 `run_update.bat` 文件。
    *   完成创建。

---

## 7. 常见问题 (FAQ)

*   **Q: `pip` 或 `pnpm` 安装失败/速度慢？**
    *   **A:** 大概率是网络问题。请参考本文档 [3.2](#32-后端配置-python) 和 [3.3](#33-前端配置-nodejs) 节中的提示，切换到国内镜像源。

*   **Q: 数据下载 (`stock_downloader.py`) 失败或中断？**
    *   **A:** `akshare` 接口可能因网络波动或API限流而出错。脚本设计有重试机制，但如果长时间失败，可以稍后再试。对于全量下载，如果中断，可以再次运行，脚本会跳过已下载的文件。

*   **Q: Web 界面显示空白或数据陈旧？**
    *   **A:** 请确保你已经成功运行了第 [4.2](#42-运行策略回测) 节中的所有回测脚本，特别是 `full_backtest.py` 和 `generate_stock_reports.py`，因为 Web 界面的所有数据都来源于它们生成的 JSON 文件。

*   **Q: PowerShell 中激活虚拟环境失败？**
    *   **A:** PowerShell 默认禁止执行脚本。请以管理员身份运行 PowerShell，执行 `Set-ExecutionPolicy RemoteSigned`，然后选择 `Y`。之后即可正常使用 `venv\Scripts\Activate.ps1` 激活环境。

---

## 8. 项目结构说明

```
tdx-strategy-backtest/
├── data/                      # 数据中心
│   ├── day/                   # 股票日线数据 (按市场分子目录 sh, sz, bj)
│   └── backtest_results/      # 原始回测结果 (已废弃，新数据在 web/client/src/data)
├── py_file/                   # Python 后端核心脚本
│   ├── stock_downloader.py    # 数据下载器
│   ├── indicators.py          # 指标计算引擎
│   ├── full_backtest.py       # 策略回测主脚本
│   ├── generate_stock_reports.py # 生成个股报告脚本
│   └── ...                    # 其他策略测试脚本
├── web/                       # 前端应用 (Vite + React)
│   ├── client/src/            # 前端源码
│   │   ├── pages/             # 页面组件
│   │   ├── components/        # 可复用组件
│   │   └── data/              # 回测数据 (JSON格式，供前端直接读取)
│   └── dist/                  # 前端构建后的静态文件目录
├── deploy/                    # 部署相关脚本和配置
├── venv/                      # Python 虚拟环境 (本地生成)
├── requirements.txt           # Python 依赖清单
├── 项目部署手册.md            # 本文档
└── 回测系统详细开发说明.md    # 开发者文档
```
