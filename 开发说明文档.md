# 股票策略回测与分析系统 - 详细开发说明文档

**版本**: 4.0.0
**更新日期**: 2026-01-16
**作者**: Manus AI

---

## 1. 系统架构与设计哲学

### 1.1. 核心设计原则

本系统采用 **“离线计算 + 静态展示”** 的架构，旨在实现高性能、低成本、高可扩展性的量化研究平台。

| 原则 | 描述 | 实现方式 |
| :--- | :--- | :--- |
| **高性能** | 充分利用多核CPU资源，加速数据处理和回测。 | Python `multiprocessing` 模块，并行数量设置为 `CPU核心数 - 1`。 |
| **低耦合** | 前后端通过静态JSON文件交换数据，完全解耦。 | 后端脚本直接输出JSON到前端数据目录，前端通过 `import` 读取。 |
| **可扩展性** | 策略和指标的添加不影响核心框架。 | 策略逻辑封装在独立的函数中，指标计算集中在 `indicators_99.py`。 |
| **自动化** | 脚本设计旨在实现最大程度的自动化，减少手动操作，如自动数据更新、报告生成和Web数据同步。 | `data_fetcher_1.py` 支持 `--full` / `--today` 模式，脚本自动输出到Web目录。 |

### 1.2. 脚本命名规范

为提高可维护性，所有脚本已按功能重新命名：

| 前缀 | 范围 | 脚本类型 | 示例 |
| :--- | :--- | :--- | :--- |
| **0** | 00-09 | 定时任务脚本 | `0_auto_update_daily.py` |
| **1** | 10-19 | 数据下载脚本 | `data_fetcher_1.py` |
| **2** | 20-29 | 分析/回测主脚本 | `2_single_strategy_backtest.py` |
| **2_1** | 2_10-2_19 | 分析/回测子脚本 | `2_1_pattern_analyzer.py` |
| **99** | 99-99 | 辅助/工具库脚本 | `indicators_99.py` |

### 1.3. 数据流线图 (完整Web菜单映射)

本图清晰展示了数据从外部API到最终Web页面的完整生命周期，并映射到Web界面的所有菜单项。

```mermaid
graph TD
    subgraph A[Phase 1: 数据获取与存储]
        A1(AKShare API) -- 股票/指数日线行情 --> A2(data_fetcher_1.py)
        A2 -- 存储/更新 --> A3[data/day/*.csv]
    end

    subgraph B[Phase 2: 核心计算与报告生成]
        direction LR
        B0[data/day/*.csv]
        
        subgraph B1[回测报告生成]
            B0 -- 读取全量数据 --> B1a(2_single_strategy_backtest.py)
            B0 -- 读取全量数据 --> B1b(2_combo_strategy_backtest.py)
            B0 -- 读取全量数据 --> B1c(2_generate_stock_reports.py)
            B1a -- JSON输出 --> C1[web/client/src/data/backtest_single.json]
            B1b -- JSON输出 --> C2[web/client/src/data/backtest_combo.json]
            B1c -- JSON输出 --> C3[web/client/src/data/stock_reports.json]
        end
        
        subgraph B2[信号分析报告生成]
            B0 -- 读取全量数据 --> B2a(2_signal_success_scanner.py)
            B2a -- 成功案例CSV --> B2b[report/signal_success_cases.csv]
            B2a -- JSON输出 --> C4[web/client/src/data/signal_summary.json]
            B2b -- 读取成功案例 --> B2c(2_1_pattern_analyzer.py)
            B2c -- JSON输出 --> C5[web/client/src/data/pattern_summary.json]
            B2c -- JSON输出 --> C6[web/client/src/data/pattern_analysis_by_signal.json]
        end
        
        subgraph B3[辅助工具]
            B1a & B1b & B1c & B2a & B2c -- 结果JSON --> B3a(99_update_web_data.py)
            B3a -- 更新元数据 --> C7[web/client/src/data/strategies.json]
        end
    end

    subgraph C[Phase 3: Web前端展示 (菜单映射)]
        C1 --> W1[回测报告]
        C2 --> W1
        C3 --> W2[报告明细]
        C4 & C5 & C6 --> W3[分析报告]
        C7 --> W4[指标方案]
        B0 --> W5[回测数据]
        C3 --> W6[可视化买点]
        
        W1 & W2 & W3 & W4 & W5 & W6 --> W7[用户界面]
    end

    style A2 fill:#FFDAB9,stroke:#333,stroke-width:2px
    style B1a fill:#ADD8E6,stroke:#333,stroke-width:2px
    style B1b fill:#ADD8E6,stroke:#333,stroke-width:2px
    style B1c fill:#ADD8E6,stroke:#333,stroke-width:2px
    style B2a fill:#ADD8E6,stroke:#333,stroke-width:2px
    style B2c fill:#ADD8E6,stroke:#333,stroke-width:2px
    style B3a fill:#D8BFD8,stroke:#333,stroke-width:2px
    style W1 fill:#90EE90,stroke:#333,stroke-width:2px
    style W2 fill:#90EE90,stroke:#333,stroke-width:2px
    style W3 fill:#90EE90,stroke:#333,stroke-width:2px
    style W4 fill:#90EE90,stroke:#333,stroke-width:2px
    style W5 fill:#90EE90,stroke:#333,stroke-width:2px
    style W6 fill:#90EE90,stroke:#333,stroke-width:2px
    style W7 fill:#F0FFF0,stroke:#333,stroke-width:2px
```

---

## 2. 后端模块功能点详细解析 (`py_file/`)

### 2.1. 定时任务脚本

| 脚本名称 | 功能点 | 详细说明 |
| :--- | :--- | :--- |
| **`0_auto_update_daily.py`** | **每日自动更新** | 整合了每日数据下载、所有回测、所有分析和Web数据同步的完整流程，用于 `crontab` 或 `systemd timer` 定时执行。 |

### 2.2. 数据下载脚本

| 脚本名称 | 功能点 | 详细说明 |
| :--- | :--- | :--- |
| **`data_fetcher_1.py`** | **数据下载与管理** | 负责从 `AKShare` 获取数据，支持 `--full` (全量)、`--today` (当日增量)、`--date` (日期范围覆盖) 三种模式。 |

### 2.3. 分析/回测主脚本

| 脚本名称 | 对应Web模块 | 详细说明 |
| :--- | :--- | :--- |
| **`2_single_strategy_backtest.py`** | **回测报告** | 运行六脉神剑、缠论等单指标策略回测，输出 `backtest_single.json`。 |
| **`2_combo_strategy_backtest.py`** | **回测报告** | 运行稳健/激进组合策略回测，输出 `backtest_combo.json`。 |
| **`2_signal_success_scanner.py`** | **分析报告** | 扫描全市场信号，筛选成功案例，输出 `signal_summary.json`。 |
| **`2_generate_stock_reports.py`** | **报告明细/可视化买点** | 生成个股的详细回测报告，包含K线图买卖点标注数据，输出 `stock_reports.json`。 |

### 2.4. 分析/回测子脚本

| 脚本名称 | 对应Web模块 | 详细说明 |
| :--- | :--- | :--- |
| **`2_1_pattern_analyzer.py`** | **分析报告** | 读取成功案例，分析信号发生时的技术指标和理论状态，输出共性模式统计。 |

### 2.5. 辅助/工具库脚本

| 脚本名称 | 脚本类型 | 详细说明 |
| :--- | :--- | :--- |
| **`indicators_99.py`** | **技术指标库** | 封装所有技术指标（MACD, KDJ, 缠论等）的计算逻辑。 |
| **`backtest_utils_99.py`** | **回测工具库** | 封装多进程并行处理、结果汇总、数据读取等通用回测辅助功能。 |
| **`99_update_web_data.py`** | **Web数据同步** | 负责将回测结果汇总并更新到前端的元数据文件 `strategies.json`，驱动 **指标方案** 菜单。 |

---

## 3. 脚本清理明细

以下脚本已被删除，其功能已整合到新的脚本中：

| 原脚本名称 | 功能描述 | 整合目标脚本 | 清理原因 |
| :--- | :--- | :--- | :--- |
| `101_six_veins_test.py` | 六脉神剑回测 | `2_single_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `102_buy_sell_points_test.py` | 买卖点回测 | `2_single_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `103_chan_buy_point_test.py` | 缠论买点回测 | `2_single_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `104_test_sell_points.py` | 卖点优化回测 | `2_single_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `105_chan_5buy_test.py` | 缠论5买点回测 | `2_single_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `201_steady_combo_test.py` | 稳健组合回测 | `2_combo_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `202_aggressive_combo_test.py` | 激进组合回测 | `2_combo_strategy_backtest.py` | 功能合并，避免重复逻辑。 |
| `full_backtest.py` | 全量回测（旧版） | `2_single_strategy_backtest.py` / `2_combo_strategy_backtest.py` | 功能被拆分和优化，旧脚本不再使用。 |
| `stock_downloader.py` | 旧版数据下载 | `data_fetcher_1.py` | 功能被 `data_fetcher_1.py` 完全取代。 |
| `force_update_data.py` | 强制更新数据 | `data_fetcher_1.py` | 功能被 `data_fetcher_1.py --date` 取代。 |
| `fix_backtest_json.py` | 修复JSON文件 | **已删除** | 随着脚本输出路径的优化，该修复脚本不再需要。 |
| `bottom_fishing_strategy.py` | 抄底策略（未完成） | **已删除** | 避免引入未完成或未使用的功能。 |

---

**文档结束**
