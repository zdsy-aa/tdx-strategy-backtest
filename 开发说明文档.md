# 股票策略回测与分析系统 - 开发说明文档

**版本**: 2.0.0
**更新日期**: 2026-01-15

---

## 1. 系统概述

本系统是一个集数据获取、策略回测、信号分析和Web可视化于一体的全栈量化研究平台。旨在为A股市场的技术分析爱好者和量化研究者提供一套完整、高效、易于扩展的工具链。

### 1.1. 设计哲学

- **数据驱动**: 所有分析和回测都基于真实的历史日线数据。
- **模块化与解耦**: 后端Python脚本与前端Web应用分离，通过JSON文件进行数据交换，降低耦合度。
- **自动化**: 脚本设计旨在实现最大程度的自动化，减少手动操作，如自动数据更新、报告生成和Web数据同步。
- **性能与效率**: 广泛使用多进程并行处理，大幅缩短全市场数据扫描和回测的时间。
- **可扩展性**: 代码结构清晰，方便开发者添加新的技术指标、回测策略或分析维度。

### 1.2. 技术栈

| 模块 | 技术 | 主要作用 |
| :--- | :--- | :--- |
| **后端 (Python)** | Python 3.11 | 核心编程语言 |
| | Pandas, NumPy | 高效的数据处理与科学计算 |
| | AKShare | 获取A股历史日线数据 |
| | `multiprocessing` | 实现多进程并行计算，提升性能 |
| **前端 (Web)** | React 18 | 构建用户界面的核心框架 |
| | TypeScript | 提供静态类型检查，增强代码健壮性 |
| | TailwindCSS | 用于快速构建现代化、响应式的UI |
| | Chart.js | 绘制各类统计图表 |
| **数据交换** | JSON | 作为前后端数据交换的标准格式 |

---

## 2. 后端模块详细说明 (`py_file/`)

后端是整个系统的核心，负责所有的数据处理、计算和分析任务。

### 2.1. `indicators.py` - 技术指标库

这是最基础的模块，定义了系统中用到的所有技术指标的计算函数。所有函数都以`pd.DataFrame`作为输入和输出，方便链式调用。

- **核心指标**: MACD, KDJ, RSI, BOLL, DMI, DMA, SAR, BBI, OBV, WR, CCI等。
- **特色指标**:
    - `calculate_six_veins()`: 计算六脉神剑指标，返回一个包含各单项指标状态和红灯总数的DataFrame。
    - `calculate_chan_theory()`: 计算缠论买点，包含分型、笔、线段的识别，并最终输出5类买点信号。
    - `calculate_buy_sell_points()`: 计算买卖点1（吸筹）和买点2（低位金叉）。
- **`calculate_all_signals()`**: 一个便捷函数，调用上述所有指标计算函数，并返回一个包含所有信号列的完整DataFrame，主要用于组合策略回测。

### 2.2. `data_fetcher.py` - 数据获取模块

负责从`AKShare`获取数据并进行本地化存储和管理。

- **主要功能**: 全量下载、增量更新、代码自动识别（沪市/深市）。
- **核心函数**:
    - `get_stock_data()`: 获取单只股票数据。
    - `update_stock_data()`: 增量更新单只股票数据，是实现自动化的关键。
    - `batch_download()`: 批量下载多只股票。
- **命令行接口**: 提供了方便的命令行工具，用于执行数据下载任务。

### 2.3. `backtest_utils.py` - 回测工具库

封装了回测过程中常用的辅助函数，旨在简化回测脚本的编写。

- **核心函数**:
    - `get_all_stock_files()`: 遍历数据目录，获取所有股票文件列表。
    - `run_backtest_on_all_stocks()`: 使用`multiprocessing.Pool`并行执行回测函数，是系统性能的保证。
    - `aggregate_results()`: 将多进程返回的零散结果进行合并和统计，计算总体胜率、平均收益等。

### 2.4. 回测与分析脚本

这些是面向最终用户的高层脚本，每个脚本都可独立运行，并完成一项特定的回测或分析任务。

- **`single_strategy_backtest.py`**: 单指标策略回测引擎。
    - **整合**: 101-105脚本。
    - **逻辑**: 遍历所有股票，对每只股票运行六脉神剑、买卖点、缠论买点等策略，计算不同持仓周期下的收益，最后汇总所有股票的结果。
    - **输出**: `backtest_single.json` (Web数据), `single_strategy_report.md` (详细报告)。

- **`combo_strategy_backtest.py`**: 组合策略回测引擎。
    - **整合**: 201-202脚本。
    - **逻辑**: 定义了“稳健型”和“激进型”两种组合策略，这些策略要求多个指标信号同时出现。回测流程与单指标类似。
    - **输出**: `backtest_combo.json` (Web数据), `combo_strategy_report.md` (详细报告)。

- **`signal_success_scanner.py`**: 信号成功案例扫描器。
    - **逻辑**: 遍历所有股票，找出所有满足条件的买入信号（如六脉4红以上、缠论一买等）。对每个信号，计算其后15个交易日的涨幅。如果涨幅 > 5%，则将其记录为“成功案例”。
    - **输出**: `signal_success_cases.csv` (供下一步分析), `signal_summary.json` (Web数据)。

- **`pattern_analyzer.py`**: 成功案例模式分析器。
    - **逻辑**: 读取`signal_success_cases.csv`，对每一个成功案例，分析其在信号触发当天的各项技术指标状态（如MACD是否金叉、KDJ是否超卖、股价是否在布林带上轨等）以及所处的市场理论阶段（道氏、威科夫）。最后，统计所有成功案例的共性特征。
    - **输出**: `pattern_summary.json`, `pattern_analysis_by_signal.json` (Web数据), `pattern_analysis_report.csv` (详细报告)。

---

## 3. 前端模块详细说明 (`web/`)

前端采用React框架，负责将后端生成的JSON数据进行可视化展示。

### 3.1. 目录结构

- `src/pages/`: 存放各个页面的主组件，如`Dashboard.tsx`, `AnalysisReport.tsx`。
- `src/components/`: 存放可复用的UI组件，如`Layout.tsx`, `Chart.tsx`。
- `src/data/`: **核心数据目录**，存放所有由Python脚本生成的JSON文件。前端应用直接从该目录读取数据。
- `src/App.tsx`: 应用主入口，负责路由配置。

### 3.2. 数据流

1.  **Python脚本**: 运行后，将计算结果（如回测统计、分析摘要）以JSON格式保存到`web/client/src/data/`目录下。
2.  **React组件**: 页面组件通过`import`语句直接导入这些JSON文件作为静态数据。
    ```typescript
    import signalSummaryData from '../data/signal_summary.json';
    ```
3.  **渲染**: 组件使用这些导入的数据来渲染图表和表格。

这种设计简化了前后端交互，无需搭建API服务器，非常适合本地量化研究环境。缺点是数据更新需要重新运行Python脚本。

### 3.3. 如何添加新页面

1.  在`src/pages/`下创建一个新的`.tsx`组件文件。
2.  在`src/App.tsx`中为新页面添加路由。
3.  在`src/components/Layout.tsx`中添加新的导航菜单项。
4.  确保新页面所需的数据能够由某个Python脚本生成到`src/data/`目录。

---

## 4. 扩展与二次开发指南

### 4.1. 添加新的技术指标

1.  在`indicators.py`中添加一个新的计算函数，例如`calculate_my_indicator()`。
2.  函数必须接收一个DataFrame并返回一个带有新指标列的DataFrame。
3.  在需要使用该指标的回测或分析脚本中（如`single_strategy_backtest.py`），导入并调用该函数。

### 4.2. 添加新的回测策略

1.  **单指标策略**: 
    - 在`single_strategy_backtest.py`中，仿照`backtest_six_veins_single()`等函数，创建一个新的回测函数，如`backtest_my_strategy_single()`。
    - 在`run_backtest()`函数中注册你的新策略。
2.  **组合策略**:
    - 在`combo_strategy_backtest.py`的`backtest_aggressive_single()`函数中，可以方便地在`combos`字典里添加新的组合条件。

### 4.3. 修改分析维度

- 如果要为成功案例分析添加新的维度，主要修改`pattern_analyzer.py`。
- 在`analyze_single_case()`函数中添加新的分析逻辑，例如计算一个新的指标状态。
- 在`generate_pattern_summary()`函数中，将新的分析结果添加到统计摘要中，以便在前端展示。

---

**文档结束**
