# 股票策略回测与分析 system - 开发说明文档

**版本**: 7.0.0 (架构重构版)
**更新日期**: 2026-01-29
**作者**: Manus AI

---

## 1. 系统架构设计

本系统采用 **“高性能并行计算 + 静态数据驱动前端”** 的架构。通过将复杂的量化计算逻辑封装在后端 Python 脚本中，并将结果输出为标准 JSON 格式，实现了前后端的完全解耦。

### 1.1. 核心设计理念

*   **模块化整合**: 将零散的脚本整合为统一的引擎（回测引擎、分析引擎），降低维护成本。
*   **多进程加速**: 核心计算模块均采用 `multiprocessing`，充分利用多核 CPU。
*   **自动化流水线**: 通过 `a0_auto_update_daily.py` 实现从数据到展示的全流程自动化。

### 1.2. 目录结构说明

| 目录 | 说明 |
| :--- | :--- |
| `py_file/` | **核心后端代码**，包含所有计算、回测和分析脚本。 |
| `data/` | 存储原始行情数据 (CSV) 和中间计算结果。 |
| `web/` | 前端 React 项目代码。 |
| `report/` | 存储生成的分析报告 (CSV/JSON)。 |
| `config/` | 配置文件目录。 |

---

## 2. 后端核心模块解析

### 2.1. 统一回测引擎 (`a2_unified_backtest.py`)

该模块是系统的核心，整合了原有的单策略回测、组合策略回测和信号扫描功能。

*   **功能**: 
    *   执行技术指标计算（依赖 `a99_indicators.py`）。
    *   模拟交易逻辑，计算胜率、盈亏比、最大回撤等。
    *   **自动同步**: 计算完成后自动更新 `web/client/src/data/strategies.json`。
*   **关键类**: `UnifiedBacktestEngine`, `WebDataUpdater`。

### 2.2. 统一分析引擎 (`a5_unified_analysis.py`)

负责深度数据挖掘和未来趋势预测。

*   **功能**:
    *   **Report**: 生成个股详细回测报告。
    *   **Dashboard**: 基于多维度指标的 AI 评分系统。
    *   **Forecast**: 集成卡尔曼滤波 (Kalman Filter) 和随机森林的趋势预测。
*   **输出**: `stock_reports.json`, `dashboard.json`, `forecast_summary.json`。

### 2.3. 数据抓取模块 (`a1_data_fetcher_mootdx.py`)

*   **技术栈**: 基于 `mootdx` 库对接通达信行情服务器。
*   **特性**: 支持多线程并发下载，具备自动重试机制，确保数据的完整性和准确性。

---

## 3. 数据流向图 (Web 菜单映射)

本图详细展示了数据从外部 API 到最终 Web 页面所有菜单项的完整生命周期。

```mermaid
graph TD
    subgraph "数据源"
        TDX[通达信服务器]
    end

    subgraph "后端计算层 (Python)"
        A1[a1_data_fetcher_mootdx.py] -->|原始数据| CSV[(data/day/*.csv)]
        
        CSV --> A2[a2_unified_backtest.py (回测引擎)]
        CSV --> A21[a21_pattern_analyzer.py (模式分析)]
        CSV --> A5[a5_unified_analysis.py (分析引擎)]
        
        A2 -->|backtest_single.json| JSON[Static JSON Files]
        A2 -->|backtest_combo.json| JSON
        A2 -->|signal_summary.json| JSON
        A2 -->|strategies.json| JSON
        
        A21 -->|pattern_summary.json| JSON
        
        A5 -->|stock_reports.json| JSON
        A5 -->|dashboard.json| JSON
        A5 -->|forecast_summary.json| JSON
    end

    subgraph "数据存储 (web/client/src/data/)"
        JSON
    end

    subgraph "前端展示层 (Web Menus)"
        JSON -->|backtest_single.json, backtest_combo.json| W1[回测数据]
        JSON -->|signal_summary.json, pattern_summary.json| W2[分析报告]
        JSON -->|strategies.json| W3[指标方案]
        JSON -->|stock_reports.json| W4[报告明细]
        JSON -->|stock_reports.json| W5[可视化买点]
        JSON -->|dashboard.json| W6[模型仪表盘]
        JSON -->|forecast_summary.json| W7[预测数据]
    end
    
    W1 & W2 & W3 & W4 & W5 & W6 & W7 --> UI[用户界面]
    
    style A2 fill:#ADD8E6,stroke:#333,stroke-width:2px
    style A5 fill:#FFB6C1,stroke:#333,stroke-width:2px
    style W1 fill:#e0f7fa
    style W2 fill:#e0f7fa
    style W3 fill:#e0f7fa
    style W4 fill:#e0f7fa
    style W5 fill:#e0f7fa
    style W6 fill:#e0f7fa
    style W7 fill:#e0f7fa
```}],path:

---

## 4. 开发规范与扩展

### 4.1. 新增策略流程
1.  在 `a99_indicators.py` 中实现指标计算逻辑。
2.  在 `a2_unified_backtest.py` 的策略配置中注册新策略。
3.  运行 `a2_unified_backtest.py` 验证回测结果。

### 4.2. 贡献代码
*   请确保所有代码符合 PEP 8 规范。
*   提交前请运行 `a0_auto_update_daily.py --full` 进行全流程回归测试。
*   更新代码后，务必同步更新相关文档。

---

**文档结束**
